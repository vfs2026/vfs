<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Labour Shift, Advance & Salary Portal (Firestore)</title>

<link rel="icon" type="image/svg+xml" href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect rx="8" ry="8" width="100%" height="100%" fill="%23ffffff"/><text x="50%" y="55%" font-size="28" font-family="Arial" font-weight="700" text-anchor="middle" fill="%23a2242a">VF</text></svg>'>

<style>
  :root{--sticky-id:100px;--sticky-name:260px}
  body{font-family:Arial,Helvetica,sans-serif;background:#f5f7fb;margin:0;color:#222}
  .wrap{max-width:1200px;margin:18px auto;padding:14px}
  .card{background:#fff;border-radius:10px;padding:14px;margin-bottom:12px;box-shadow:0 6px 20px rgba(20,20,40,0.05)}
  h1{margin:6px 0 12px;font-size:20px;display:flex;align-items:center;gap:10px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  input,select,button,textarea{font-size:14px;padding:8px;border-radius:8px;border:1px solid #d6e0ef}
  button{cursor:pointer}
  .btn{background:#0b79ff;color:#fff;border:none}
  .btn-muted{background:#6c757d;color:#fff;border:none}
  .success{background:#28a745;color:#fff;border:none}
  .danger{background:#dc3545;color:#fff;border:none}
  table{border-collapse:collapse;width:100%;font-size:13px}
  th,td{border:1px solid #e8eef8;padding:6px;text-align:center;white-space:nowrap}
  
  /* --- STICKY HEADER AND COLUMN STYLES (REVISED) --- */
  th{background:#f3f8ff}
  
  /* 1. Sticky Header Row: fixed at the top of the scrolling area */
  table thead th {
    position: sticky;
    top: 0;
    /* Z-index high enough to overlap regular cells (1), but lower than corner (11) */
    z-index: 5; 
    background: #f3f8ff; 
  }

  /* 2. Sticky Column Styles: fixed at the left side */
  .sticky-id, .sticky-name {
    position: sticky !important; 
    /* Z-index high enough to overlap the header row */
    z-index: 10 !important; 
    background: #fff !important; 
  }

  /* Sticky ID Column (left-most) */
  table thead th.sticky-id, table tbody td.sticky-id{ 
    left:0; 
    min-width:var(--sticky-id);
    /* For the header cell, use the header background color */
    background: #f3f8ff !important; 
    z-index: 11 !important; /* Make the corner cell the highest */
  }
  
  /* Sticky Name Column */
  table thead th.sticky-name, table tbody td.sticky-name{ 
    left:var(--sticky-id); 
    min-width:var(--sticky-name); 
    text-align:left; 
    padding-left:10px;
    /* For the header cell, use the header background color */
    background: #f3f8ff !important; 
  }
  
  /* Ensure the body cells in sticky columns use a white background when scrolling */
  table tbody td.sticky-id, table tbody td.sticky-name {
    background: #fff !important;
  }
  
  /* --- END STICKY HEADER AND COLUMN STYLES --- */

  .small{font-size:12px;color:#555}
  .muted{color:#666}
  .hidden{display:none}
  
  /* CRITICAL FIX: Add max-height to force internal scrolling required for position:sticky */
  .table-wrap{
    overflow:auto;
    background:#fff;
    padding:8px;
    border-radius:8px;
    max-height: 70vh; /* Crucial for enabling vertical sticky position */
  }
  
  @media (max-width:1100px){ :root{--sticky-name:160px} }
  .controls{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .search{width:260px}
  .logo { width:36px; height:36px; border-radius:6px; object-fit:cover; }
  .logo-large { width:48px; height:48px; border-radius:6px; object-fit:cover; }
  .header-title { display:flex; align-items:center; gap:10px; }
  .small-muted-note { color:#666; font-size:12px; }

  /* ensure focused input appears above sticky columns so it is not hidden */
  input:focus, textarea:focus, select:focus {
    position: relative;
    z-index: 9999 !important;
    outline: 2px solid rgba(11,121,255,0.15);
  }

  /* small tweak so clicking a cell doesn't auto-select the row behind it */
  .attCell { background: #fff; }

  /* Drag & drop styles */
  .draggable-row { cursor:grab; }
  .dragging { opacity: 0.5; }
  .drop-target { outline: 2px dashed rgba(11,121,255,0.35); }
  .reorder-controls { display:flex; gap:8px; align-items:center; margin-top:6px; }
  .small-note { font-size:12px; color:#666; margin-left:6px; }

  /* Tab Styles */
  #tabContainer {
    display: flex;
    margin: 12px 0 0;
    border-bottom: 2px solid #e8eef8;
    gap: 1px;
    padding: 0 0 0;
  }
  .tab-btn {
    padding: 10px 18px;
    background: #f5f7fb;
    border: 1px solid #e8eef8;
    border-bottom: none;
    border-top-left-radius: 8px;
    border-top-right-radius: 8px;
    color: #444;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.1s, color: 0.1s;
    margin-bottom: -1px; /* Overlap border */
  }
  .tab-btn:hover {
    background: #fff;
    color: #0b79ff;
  }
  .tab-btn.active {
    background: #fff;
    border-color: #e8eef8;
    border-bottom: 2px solid #fff; /* White border to cover container's bottom border */
    color: #0b79ff;
  }
  
  /* Hide content that is outside the active tab */
  .tab-content {
      padding: 0;
      margin-bottom: 0;
      box-shadow: none;
  }
  /* Re-apply some padding inside the wrapper for the table/content */
  #ownerTableWrap, #advancesCard > div, #salaryCard > div {
      padding: 14px;
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card" id="homeCard">
    <h1>
      <img id="appLogo" src='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120"><rect rx="12" ry="12" width="100%" height="100%" fill="%23ffffff"/><text x="50%" y="56%" font-size="36" font-family="Arial" font-weight="700" text-anchor="middle" fill="%23a2242a">VF</text></svg>' alt="logo" class="logo">
      <span>Labour Shift, Advance & Salary Portal (Firestore)</span>
    </h1>
    <div class="row">
      <button class="btn" id="ownerBtn">Owner Login</button>
      <button class="btn-muted" id="labourBtn">Labour Login</button>
      <div style="flex:1"></div>
    </div>
    <p class="small muted">Owner must sign in to perform saves (Firestore writes).</p>
  </div>

  <div class="card hidden" id="ownerLoginCard">
    <h3><img id="loginLogo" src='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120"><rect rx="12" ry="12" width="100%" height="100%" fill="%23ffffff"/><text x="50%" y="56%" font-size="36" font-family="Arial" font-weight="700" text-anchor="middle" fill="%23a2242a">VF</text></svg>' class="logo-large" alt="logo"> Owner Login (Firebase)</h3>
    <label>Email</label><br>
    <input id="ownerEmail" type="email" placeholder="owner@example.com" autocomplete="off"><br>
    <label>Password</label><br>
    <input id="ownerPassword" type="password" placeholder="password" autocomplete="off">
    <div style="margin-top:10px">
      <button class="btn" id="ownerLogin">Sign In</button>
      <button id="ownerBack">Back</button>
    </div>
    <div id="ownerAuthMsg" class="small muted" style="margin-top:8px"></div>
  </div>

  <div class="card hidden" id="labourLoginCard">
    <h3><img src='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120"><rect rx="12" ry="12" width="100%" height="100%" fill="%23ffffff"/><text x="50%" y="56%" font-size="36" font-family="Arial" font-weight="700" text-anchor="middle" fill="%23a2242a">VF</text></svg>' class="logo-large" alt="logo"> Labour Login (ID only)</h3>
    <label>User ID</label><br>
    <input id="labUserId" placeholder="L001" autocomplete="off">
    <div style="margin-top:10px">
      <button class="btn" id="labourLoginBtn">Login</button>
      <button id="labourBack">Back</button>
    </div>
    <p class="small muted">Labour login requires only User ID — no password shown to labour.</p>
  </div>

  <div class="card hidden" id="ownerDashboard">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h2 style="display:flex;align-items:center;gap:10px"><img src='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120"><rect rx="12" ry="12" width="100%" height="100%" fill="%23ffffff"/><text x="50%" y="56%" font-size="36" font-family="Arial" font-weight="700" text-anchor="middle" fill="%23a2242a">VF</text></svg>' class="logo" alt="logo"> Owner Dashboard</h2>
      <div><button id="ownerLogout">Sign Out</button></div>
    </div>
    
    <div id="tabContainer">
        <button class="tab-btn active" data-tab="attendance">Attendance & Shifts</button>
        <button class="tab-btn" data-tab="advances">Advances</button>
        <button class="tab-btn" data-tab="salary">Salary Sheet</button>
    </div>

    <div id="attendanceTabContent" class="tab-content card">
        <div class="controls">
          <label>Month</label>
          <input type="month" id="ownerMonth">
          <button class="btn" id="loadTable">Load Table</button>
          <div style="flex:1"></div>
          <label>Search</label>
          <input id="ownerSearch" class="search" placeholder="ID or name" oninput="ownerFilter()">
          <button class="success" id="saveAll">Save Shifts</button>
          <button id="exportShiftCSV">Export CSV</button>
          <button id="exportShiftXLS">Export XLS</button>
          <button id="exportShiftPDF">Export PDF</button>
        </div>
        <div id="ownerTableWrap" class="table-wrap card"></div>
    </div>


    <div id="advancesTabContent" class="tab-content card hidden">
        <div class="card" id="advancesCard" style="margin-top:0">
          <h3>Advances Management</h3>
          <div style="display:flex;align-items:center;gap:8px">
            <label>Month</label><input type="month" id="advMonth">
            <button id="showAdv">Show</button>
            <div style="flex:1"></div>
            <button id="exportAdvCSV">Export Adv CSV</button>
            <button id="exportAdvXLS">Export Adv XLS</button>
            <button id="exportAdvPDF">Export Adv PDF</button>
          </div>
          <div style="display:flex;gap:12px;margin-top:12px">
            <div style="flex:1">
              <table id="advTable"><thead><tr><th>S.No</th><th>ID</th><th>Name</th><th>Total (₹)</th><th>Actions</th></tr></thead><tbody></tbody></table>
            </div>
            <div style="width:360px">
              <h4>Add/Edit Advance</h4>

              <label>Search Labour (type to filter)</label>
              <input id="advSearch" placeholder="Search by ID or name" autocomplete="off" style="width:100%;margin-bottom:6px" />
              <label>Labour</label>
              <select id="advLab" style="width:100%"></select>
              
              <label style="margin-top:8px; display:block;">Edit Existing Advance</label>
              <select id="advEditDate" style="width:100%"></select>
              <p class="small muted" style="margin-bottom:8px;">Select a dated entry above to edit, or leave empty to add new.</p>
              <label>Date</label><input id="advDate" type="date">
              <label>Amount (₹)</label><input id="advAmt" type="number" min="0" step="0.01">
              <label>Note</label><textarea id="advNote" rows="3" style="width:100%"></textarea>
              <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
                <button class="btn" id="saveAdv">Save Advance</button>
                <button id="clearAdv">Clear</button>
              </div>
            </div>
          </div>
        </div>
    </div>


    <div id="salaryTabContent" class="tab-content card hidden">
        <div class="card" id="salaryCard" style="margin-top:0">
          <h3>Salary Sheet</h3>
        <div style="display:flex;gap:8px;align-items:center">
  <label>Month</label>
  <input type="month" id="salaryMonth">
  <button id="showSalary">Show Salary</button>

  <label style="margin-left:12px">Search</label>
  <input id="salarySearch"
         class="search"
         placeholder="ID or name"
         oninput="salaryFilter()">

  <div style="flex:1"></div>
  <button class="success" id="saveSalary">Save Salary Sheet</button>
  <button id="exportSalaryCSV">Export CSV</button>
  <button id="exportSalaryXLS">Export XLS</button>
  <button id="exportSalaryPDF">Export PDF</button>
</div>

          <div class="table-wrap" style="margin-top:10px">
            <table id="salaryTable"><thead><tr>
              <th class="sticky-id">S.No</th><th class="sticky-name">User ID - Name</th>
              <th>Amt/Shift</th><th>Total Shift</th><th>Total Amt</th>
              <th>Monthly Advance</th><th>Mess</th><th>U/F</th><th>P/F</th><th>Debit</th><th>JVC</th><th>Other</th><th>Payment Mode</th><th>Paid Salary</th><th>Remarks/Sign</th>
            </tr></thead><tbody></tbody></table>
          </div>
          <p class="small muted">Paid = TotalAmt − (MonthlyAdvance + Mess + U/F + P/F + Debit + JVC + Other). Owner may override Paid before saving.</p>
        </div>
    </div>
    
    <div class="card" style="margin-top:12px; padding: 14px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3 style="margin:0;">Manage Labours (Master Data)</h3>
          <button id="addLabour">Add Labour</button>
        </div>

        <div class="reorder-controls">
          <button id="enableReorder" class="btn">Enable Reorder</button>
          <button id="fixOrderBtn" class="success hidden">Fix Order (Save)</button>
          <button id="cancelReorderBtn" class="danger hidden">Cancel</button>
          <div class="small-note">Drag rows to reorder when reorder is enabled.</div>
        </div>

        <div id="labourList"></div>
    </div>
    
    <div style="margin-top:12px; padding: 14px;">
        <div style="text-align:right;"><button id="exportBackup">Export Full Backup (local snapshot)</button></div>
        <p class="small-muted-note" style="text-align:right;">(Owner only - this exports a snapshot of all data from Firestore to your browser's Downloads folder)</p>
    </div>

  </div>

  <div class="card hidden" id="labourDashboard">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h2><img src='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120"><rect rx="12" ry="12" width="100%" height="100%" fill="%23ffffff"/><text x="50%" y="56%" font-size="36" font-family="Arial" font-weight="700" text-anchor="middle" fill="%23a2242a">VF</text></svg>' class="logo" alt="logo"> Labour Portal</h2>
      <div><button id="labourLogout">Back</button></div>
    </div>
    <div id="labourInfo"></div>
    <label>Select Month</label>
    <input type="month" id="labourMonth" onchange="renderLabourView()">
    <div id="labourAttendance" class="card" style="margin-top:8px"></div>
    <div id="labourAdvance" class="card" style="margin-top:8px"></div>
    <div id="labourSalary" class="card" style="margin-top:8px"></div>
  </div>

  <div class="card hidden" id="labourModal">
    <h3 id="labourModalTitle">Add Labour</h3>
    <label>User ID</label><input id="modalUserId"><br>
    <label>Name</label><input id="modalName"><br>
    <label>Password</label><input id="modalPwd"><br>
    <label>Rate per shift (₹)</label><input id="modalRate" type="number" min="0" step="0.01"><br>
    <label>Payment Mode</label>
    <select id="modalPayMode" style="width:120px">
      <option value="Cash">Cash</option>
      <option value="A/c">A/c</option>
    </select>
    <div style="margin-top:10px">
      <button class="btn" id="saveLabourBtn">Save</button>
      <button id="cancelLabourBtn">Cancel</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
/* ---------------------------
  Put your firebase config here (you gave this earlier)
---------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyD4Ax31xHSiW4d4j-YgwcmvH1kPc4OrUoU",
  authDomain: "vfs-labour-portal-8ba3c.firebaseapp.com",
  projectId: "vfs-labour-portal-8ba3c",
  storageBucket: "vfs-labour-portal-8ba3c.firebasestorage.app",
  messagingSenderId: "212643125844",
  appId: "1:212643125844:web:ff2757e75fd37203fc6bc1",
  measurementId: "G-1SF18YYT6P"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* OWNER UID — set to the UID you created in Firebase Auth */
const OWNER_UID = 'D0iiwtC6w9O9qImWLQUXDxKP7lc2'; // <-- replace with your owner UID if different

/* Global state for Advance Editing */
let advanceToEdit = null;
let currentLabourAdvances = []; // Store the full list of advances

/* ===== Simple DOM helper ===== */
const $ = id => document.getElementById(id);

/* ===== Navigation UI wiring ===== */
function hideAll(){ ['ownerLoginCard','labourLoginCard','ownerDashboard','labourDashboard','labourModal'].forEach(id=>$(id).classList.add('hidden')); $('homeCard').classList.add('hidden'); }
$('ownerBtn').onclick = ()=>{ hideAll(); $('ownerLoginCard').classList.remove('hidden'); scrollToTop(); };
$('labourBtn').onclick = ()=>{ hideAll(); $('labourLoginCard').classList.remove('hidden'); scrollToTop(); };
$('ownerBack').onclick = ()=>location.reload();
$('labourBack').onclick = ()=>location.reload();

/* quick helper for scrolling */
function scrollToTop(){ window.scrollTo({top:0, behavior:'smooth'}); }
function scrollToElement(el){ if(!el) return; el.scrollIntoView({behavior:'smooth', block:'center'}); }

/* ===== Auth (owner sign-in) ===== */
$('ownerLogin').onclick = async ()=>{
  const email = $('ownerEmail').value.trim();
  const pwd = $('ownerPassword').value.trim();
  if(!email || !pwd){ alert('Enter email and password'); return; }
  try{
    const userCred = await auth.signInWithEmailAndPassword(email, pwd);
    const uid = userCred.user.uid;
    $('ownerAuthMsg').textContent = 'Signed in UID: ' + uid;
    if(uid !== OWNER_UID) {
      alert('Signed in UID does not match OWNER_UID variable. Update OWNER_UID in code or use the owner with that UID.');
    }
    hideAll(); $('ownerDashboard').classList.remove('hidden'); await initOwnerView(); scrollToTop();
  } catch(err){
    alert('Sign in failed: ' + err.message);
  }
};
$('ownerLogout').onclick = async ()=>{ await auth.signOut(); location.reload(); };

/* ===== Labour login (ID only) ===== */
let currentLabour = null;
$('labourLoginBtn').onclick = async ()=>{
  const id = $('labUserId').value.trim();
  if(!id){ alert('Enter your User ID'); return; }
  try {
    const labDoc = await db.collection('labours').doc(id).get();
    if(!labDoc.exists){
      alert('User ID not found in Firestore. Create labour as owner first.');
      return;
    }
    currentLabour = labDoc.data();
    currentLabour.id = labDoc.id;
    hideAll(); $('labourDashboard').classList.remove('hidden');
    $('labourMonth').value = (new Date()).toISOString().slice(0,7);
    renderLabourInfo(); renderLabourView(); scrollToTop();
  } catch(err){
    alert('Error fetching labour: ' + err.message);
  }
};
$('labourLogout').onclick = ()=> location.reload();

/* ========== Firestore helper functions ========== */

/* Labours collection: doc id = labour id
   NOTE: we fetch all docs and sort client-side by 'order' (if present) or 'createdAt' */
async function fetchAllLabours(){
  const snap = await db.collection('labours').get();
  const labs = snap.docs.map(d => ({id: d.id, ...d.data()}));
  // sort: first by explicit numeric 'order' (if present), else by createdAt (timestamp), else by id
  labs.sort((a,b) => {
    const ao = (a.order === undefined || a.order === null) ? Number.POSITIVE_INFINITY : Number(a.order);
    const bo = (b.order === undefined || b.order === null) ? Number.POSITIVE_INFINITY : Number(b.order);
    if(ao !== bo) return ao - bo;
    // tie-breaker: createdAt
    const at = a.createdAt && a.createdAt.toMillis ? a.createdAt.toMillis() : (a.createdAt ? new Date(a.createdAt).getTime() : 0);
    const bt = b.createdAt && b.createdAt.toMillis ? b.createdAt.toMillis() : (b.createdAt ? new Date(b.createdAt).getTime() : 0);
    if(at !== bt) return at - bt;
    // final fallback: id
    return (a.id || '').localeCompare(b.id || '');
  });
  return labs;
}

async function fetchLabourById(id){
  const d = await db.collection('labours').doc(id).get();
  if(!d.exists) return null;
  return {id: d.id, ...d.data()};
}
async function saveLabourToFirestore(lab){
  const ref = db.collection('labours').doc(lab.id);
  const doc = await ref.get();
  const payload = {
    name: lab.name || '',
    password: lab.password || '',
    rate: Number(lab.rate) || 0,
    paymentMode: lab.paymentMode || 'Cash',
    id: lab.id
  };
  if(!doc.exists){
    payload.createdAt = firebase.firestore.FieldValue.serverTimestamp();
  }
  await ref.set(payload, {merge:true});
}
async function deleteLabourFromFirestore(id){
  await db.collection('labours').doc(id).delete();
  const attAll = await db.collection('attendance').get();
  const batch = db.batch();
  attAll.docs.forEach(doc => {
    if(doc.id.startsWith(id + '_')) batch.delete(doc.ref);
  });
  const advDoc = db.collection('advances').doc(id);
  batch.delete(advDoc);
  const salAll = await db.collection('salaries').get();
  salAll.docs.forEach(doc => { if(doc.id.startsWith(id + '_')) batch.delete(doc.ref); });
  await batch.commit();
}

/* Attendance docs: id = `${labId}_${month}` */
async function fetchAttendance(labId, month){
  const id = `${labId}_${month}`;
  const d = await db.collection('attendance').doc(id).get();
  return d.exists ? d.data() : {shifts:{}, rate: null};
}
async function saveAttendanceForMonth(attObjMap){
  const batch = db.batch();
  for(const key of Object.keys(attObjMap)){
    batch.set(db.collection('attendance').doc(key), attObjMap[key], {merge:true});
  }
  await batch.commit();
}

/* Advances docs */
async function fetchAdvancesForLab(labId){
  const d = await db.collection('advances').doc(labId).get();
  // Ensure that items array exists and is an array
  const items = d.exists ? (d.data().items || []) : [];
  // Sort items by date before returning
  items.sort((a,b) => a.date < b.date ? -1 : (a.date > b.date ? 1 : 0));
  return items;
}
async function appendAdvanceForLab(labId, advanceItem){
  const ref = db.collection('advances').doc(labId);
  await ref.set({ items: firebase.firestore.FieldValue.arrayUnion(advanceItem) }, {merge:true});
}

/* Salaries docs */
async function fetchSalary(labId, month){
  const id = `${labId}_${month}`;
  const d = await db.collection('salaries').doc(id).get();
  return d.exists ? d.data() : null;
}
async function saveSalaryRecord(labId, month, payload){
  const id = `${labId}_${month}`;
  await db.collection('salaries').doc(id).set(payload, {merge:true});
}

/* Helper: collect all attendance docs for a month (for owner table export) */
async function collectAttendanceForMonth(month){
  const labs = await fetchAllLabours();
  const rows = [];
  for(const [i,l] of labs.entries()){
    const key = `${l.id}_${month}`;
    const doc = await db.collection('attendance').doc(key).get();
    const rec = doc.exists ? doc.data() : {shifts:{}};
    rows.push({ sno: i+1, id: l.id, name: l.name, shifts: rec.shifts || {}, rate: rec.rate || l.rate });
  }
  return { rows, labs };
}

/* ========== UI functions that use Firestore ========== */

/* Tab Switching Logic */
const tabContentMap = {
    attendance: $('attendanceTabContent'),
    advances: $('advancesTabContent'),
    salary: $('salaryTabContent')
};

function switchTab(tabName) {
    // 1. Hide all content and remove active class from all buttons
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

    // 2. Show the target content and set the button active
    const content = tabContentMap[tabName];
    const button = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
    
    if (content && button) {
        content.classList.remove('hidden');
        button.classList.add('active');
        // 3. Trigger initial load/render logic for the tab if necessary
        if (tabName === 'attendance') {
            generateOwnerTable(false); // Force load attendance table on switch
        } else if (tabName === 'advances') {
            renderAdvances();
        } else if (tabName === 'salary') {
            renderSalarySheet();
        }
    }
}

document.querySelectorAll('.tab-btn').forEach(button => {
    button.addEventListener('click', (e) => {
        const tab = e.target.dataset.tab;
        switchTab(tab);
    });
});


/* Init owner view: fetch labours to render */
async function initOwnerView(){
  $('ownerMonth').value = (new Date()).toISOString().slice(0,7);
  $('advMonth').value = $('ownerMonth').value;
  $('salaryMonth').value = $('ownerMonth').value;
  await renderLabourList();
  await populateAdvSelect();
  
  // Start on the attendance tab
  switchTab('attendance'); 
  // Generate the table now that the month is set
  await generateOwnerTable(); 
}

/* Generate owner attendance table (pulls attendance docs from Firestore) */
async function generateOwnerTable(scrollToTop = true){
  const month = $('ownerMonth').value; if(!month){ alert('Select month'); return; }
  const days = getDays(month);
  const labs = await fetchAllLabours();
  const attMap = {};
  await Promise.all(labs.map(async l => {
    const key = `${l.id}_${month}`;
    const d = await db.collection('attendance').doc(key).get();
    attMap[l.id] = d.exists ? d.data() : {shifts:{}, rate: l.rate};
  }));
  let html = '<table id="ownerTable"><thead><tr><th class="sticky-id">S.No</th><th class="sticky-name">User ID - Name</th>';
  days.forEach(d=> html += `<th>${d}</th>`);
  html += '<th>Total</th><th>Actions</th></tr></thead><tbody>';
  labs.forEach((l,i)=>{
    const rec = attMap[l.id] || {shifts:{}, rate:l.rate};
    let total = 0;
    html += `<tr data-id="${l.id}"><td class="sticky-id">${i+1}</td><td class="sticky-name">${l.id} - ${l.name}</td>`;
    days.forEach(d=>{ const v = rec.shifts && (rec.shifts[d] !== undefined) ? rec.shifts[d] : 0; total += Number(v)||0; html += `<td><input type="number" step="0.25" min="0" class="attCell" data-day="${d}" data-id="${l.id}" value="${v}" style="width:78px"></td>`;});
    html += `<td class="rowTotal">${Number(total).toFixed(2)}</td><td><button onclick="prefillAdv('${l.id}')">Add Advance</button> <button onclick="viewAdvances('${l.id}')">View</button></td></tr>`;
  });
  html += '</tbody></table>';
  $('ownerTableWrap').innerHTML = html;

  // add behavior: auto-select text on focus & arrow navigation & ensure focused input sits above sticky columns
  document.querySelectorAll('.attCell').forEach((el) => {
    // auto select on focus (works for mouse and tab)
    el.addEventListener('focus', (ev) => {
      try { ev.target.select(); } catch(e) {}
      // ensure z-index while focused so sticky name doesn't cover it
      ev.target.style.zIndex = '9999';
    });
    el.addEventListener('blur', (ev) => {
      ev.target.style.zIndex = '';
    });

    // allow decimal by keeping step - already set, but ensure input type allows '.' on locales
    el.addEventListener('keydown', attCellKeyHandler);

    // update totals on change/input
    el.addEventListener('input', () => { updateRowTotals(); }); 
  });

  updateRowTotals();
  if(scrollToTop) scrollToElement($('ownerTableWrap'));
}
$('loadTable').onclick = generateOwnerTable;

function updateRowTotals(){
  document.querySelectorAll('#ownerTable tbody tr').forEach(tr=>{
    let s = 0;
    tr.querySelectorAll('.attCell').forEach(ci=> s += Number(ci.value) || 0);
    const cell = tr.querySelector('.rowTotal'); if(cell) cell.textContent = Number(s).toFixed(2);
  });
}

/* Save attendance to Firestore (owner-only) */
$('saveAll').onclick = async ()=>{
  if(!isOwnerSignedIn()){ alert('Owner sign-in required to save.'); return; }
  const month = $('ownerMonth').value; if(!month){ alert('Select month'); return; }
  const toSave = {};
  document.querySelectorAll('#ownerTable tbody tr').forEach(tr=>{
    const id = tr.dataset.id;
    const key = `${id}_${month}`;
    const shifts = {};
    tr.querySelectorAll('.attCell').forEach(ci => { const d = ci.dataset.day; shifts[d] = Number(ci.value) || 0; });
    const rate = Number(getRateForLabour(id)) || null;
    toSave[key] = { shifts, rate };
  });
  try {
    await saveAttendanceForMonth(toSave);
    alert('Attendance saved to Firestore.');
  } catch(err){
    alert('Save failed: ' + err.message);
  }
};

/* Owner search */
function salaryFilter(){
  const q = $('salarySearch').value.trim().toLowerCase();

  document.querySelectorAll('#salaryTable tbody tr').forEach(tr => {
    const text = (
      tr.querySelector('.sticky-name')?.textContent || ''
    ).toLowerCase();

    tr.style.display = (!q || text.includes(q)) ? '' : 'none';
  });
}

// Note: oninput is wired directly to the HTML now

/* Advances UI */
async function populateAdvSelect(){
  const sel = $('advLab'); sel.innerHTML = '';
  const editSel = $('advEditDate'); editSel.innerHTML = '<option value="">-- Add New Advance --</option>'; // Always add default option
  
  const labs = await fetchAllLabours();
  
  // 1. Populate Labour Dropdown
  labs.forEach(l => {
    const o = document.createElement('option'); o.value = l.id; o.textContent = l.id + ' - ' + l.name; sel.appendChild(o);
  });

  // 2. Wire Labour Change: Reload Edit Dates when Labour changes
  sel.onchange = async function() {
      await loadEditDatesForSelectedLabour(this.value);
  };
  
  // 3. Wire Edit Date Change: Load Advance for editing when Date changes
  editSel.onchange = loadAdvanceForEdit;
  
  // 4. Wire searchable advSearch input (as before)
  const advSearch = $('advSearch');
  advSearch.oninput = function() {
    const q = this.value.trim().toLowerCase();
    const found = labs.find(x => (x.id && x.id.toLowerCase().startsWith(q)) || (x.name && x.name.toLowerCase().includes(q)));
    if(found) {
      $('advLab').value = found.id;
      // Also update the edit dates for the new selection
      loadEditDatesForSelectedLabour(found.id); 
    }
  };

  // 5. Initial Load: Load edit dates for the currently selected labour (default is the first one)
  if(labs.length > 0) {
      await loadEditDatesForSelectedLabour(labs[0].id);
  } else {
      editSel.innerHTML = '<option value="">No Labours</option>';
  }
}

// Helper to load edit dates and advances array for selected labour
async function loadEditDatesForSelectedLabour(labId) {
    const editSel = $('advEditDate');
    editSel.innerHTML = '<option value="">-- Add New Advance --</option>'; // Reset
    
    // Fetch all advances for the labour (already sorted by date in fetchAdvancesForLab)
    currentLabourAdvances = await fetchAdvancesForLab(labId);
    
    // Populate the select box with the date + amount
    currentLabourAdvances.forEach((a, index) => {
        // Use the array index as the value for easy lookup later
        const o = document.createElement('option');
        o.value = index; 
        o.textContent = `${a.date} (₹${a.amount})`; 
        editSel.appendChild(o);
    });
    
    // Clear the edit state and form inputs
    $('advEditDate').value = "";
    clearAdvForm();
}

// Function called when a user selects a date to edit
function loadAdvanceForEdit() {
    const index = $('advEditDate').value;
    
    // Clear previous state
    advanceToEdit = null; 
    clearAdvForm(); // Clears form, but not the advEditDate selection
    $('advEditDate').value = index; // Restore the selection after clearAdvForm runs
    
    if (index === "") {
        // User selected '-- Add New Advance --'
        return; 
    }
    
    const advance = currentLabourAdvances[Number(index)];
    
    if (advance) {
        // We must store a copy of the advance that matches the one in Firestore (same structure)
        // Note: Firestore arrayRemove needs an exact match of the item added via arrayUnion
        // Ensure amount is parsed as a Number for the key
        advanceToEdit = { date: advance.date, amount: Number(advance.amount), note: advance.note }; 
        $('advDate').value = advance.date;
        // Keep amount as number in the input, but format for display consistency if needed
        $('advAmt').value = Number(advance.amount).toFixed(2);
        $('advNote').value = advance.note;
        alert(`Loaded advance from ${advance.date} for editing. Press 'Save Advance' to commit changes.`);
    }
}

function clearAdvForm() {
    $('advDate').value = (new Date()).toISOString().slice(0,10); // set to today by default for new
    $('advAmt').value = ''; 
    $('advNote').value = '';
    // Also clear the edit date selection
    $('advEditDate').value = ""; 
    advanceToEdit = null;
}
$('clearAdv').onclick = clearAdvForm; 


$('showAdv').onclick = renderAdvances;

async function renderAdvances(){
  const month = $('advMonth').value || $('ownerMonth').value;
  const labs = await fetchAllLabours();
  const tbody = document.querySelector('#advTable tbody'); tbody.innerHTML = '';
  for(let i=0;i<labs.length;i++){
    const l = labs[i];
    // Fetch all advances and filter client-side
    const items = await fetchAdvancesForLab(l.id);
    const filtered = items.filter(a => a.date && a.date.startsWith(month));
    const tot = filtered.reduce((s,x)=> s + (Number(x.amount)||0), 0);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${l.id}</td><td class="left">${l.name}</td><td>₹${tot.toFixed(2)}</td><td><button onclick="prefillAdv('${l.id}')">Add/Edit</button> <button onclick="viewAdvances('${l.id}','${month}')">View</button></td>`;
    tbody.appendChild(tr);
  }
  await populateAdvSelect();
  scrollToElement($('advancesCard'));
}

/* Save advance (owner-only) - MODIFIED: ALLOWS 0 AMOUNT FOR EDITS */
$('saveAdv').onclick = async ()=>{
  if(!isOwnerSignedIn()){ alert('Owner sign-in required to save advance.'); return; }
  
  const labId = $('advLab').value; 
  const newDate = $('advDate').value; 
  // Ensure newAmt is always a Number, 0 if input is empty or invalid
  const newAmt = Number($('advAmt').value) || 0; 
  const newNote = $('advNote').value;
  
  const isEditing = advanceToEdit !== null;

  // --- MODIFIED VALIDATION LOGIC ---
  if(!labId || !newDate){ 
      alert('Select labour and date.'); 
      return; 
  }

  // Prevent adding a brand new advance with zero or negative amount
  if (!isEditing && newAmt <= 0) {
      alert('Amount must be positive when adding a new advance.');
      return;
  }
  // --- END MODIFIED VALIDATION LOGIC ---


  const advRef = db.collection('advances').doc(labId);
  
  try{
    await db.runTransaction(async (transaction) => {
        // The item to be added/updated (Amount is Number type)
        const newAdvanceItem = { date: newDate, amount: newAmt, note: newNote };

        if (isEditing) {
            // 1. REMOVE the old advance object (must be exact object: date, amount, note)
            transaction.update(advRef, { 
                items: firebase.firestore.FieldValue.arrayRemove(advanceToEdit)
            });
        }
        
        // 2. ADD the new advance object (the edited or newly added one)
        // This will successfully add the new advance, even if newAmt is 0 (if editing)
        transaction.update(advRef, { 
            items: firebase.firestore.FieldValue.arrayUnion(newAdvanceItem)
        });
    });

    clearAdvForm();
    await renderAdvances(); 
    await loadEditDatesForSelectedLabour(labId); 
    alert(`Advance ${isEditing ? 'edited' : 'saved'} to Firestore.`);
  } catch(err){
    alert('Save advance failed: ' + err.message);
    console.error(err);
  }
};


// Prefill and navigate to advances tab and scroll to card
function prefillAdv(id){
    // 1. Switch to the Advances tab
    switchTab('advances'); 
    
    // 2. Prefill the Labour dropdown with the selected ID
    $('advLab').value = id; 
    
    // 3. Force load the edit dates for the newly selected labour
    loadEditDatesForSelectedLabour(id).then(() => {
        // 4. Set the default date to today and focus on the amount input
        $('advDate').value = (new Date()).toISOString().slice(0,10); 
        $('advAmt').focus(); 
        // 5. Scroll the Advances card into the center view
        scrollToElement($('advancesCard')); 
    });
}

/* View advances (open in new tab) */
async function viewAdvances(id, month){
  const items = await fetchAdvancesForLab(id);
  let list = items;
  if(month) list = list.filter(a=> a.date && a.date.startsWith(month));
  list.sort((a,b)=> a.date < b.date ? -1 : (a.date > b.date ? 1 : 0));
  let html = `<html><head><meta charset="utf-8"><title>Advances ${id}</title><style>table{border-collapse:collapse;width:100%}th,td{border:1px solid #333;padding:6px}th{background:#eee}</style></head><body><h2>Advances — ${id}</h2>`;
  if(list.length === 0) html += '<p>No advances</p>'; else {
    html += '<table><thead><tr><th>Date</th><th>Amount</th><th>Note</th></tr></thead><tbody>';
    list.forEach(a=> html += `<tr><td>${a.date}</td><td style="text-align:right">₹${Number(a.amount).toFixed(2)}</td><td>${a.note||''}</td></tr>`);
    html += '</tbody></table>';
    const tot = list.reduce((s,x)=> s + (Number(x.amount)||0), 0);
    html += `<p><strong>Total: ₹${tot.toFixed(2)}</strong></p>`;
  }
  html += '</body></html>';
 const blob = new Blob([html], { type: 'text/html' });
const url = URL.createObjectURL(blob);

const a = document.createElement('a');
a.href = url;
a.download = `salary_sheet_${month}.pdf`;
document.body.appendChild(a);
a.click();
a.remove();

URL.revokeObjectURL(url);

}

/* Save Salary Sheet (owner-only) */
$('saveSalary').onclick = async ()=>{
  if(!isOwnerSignedIn()){ alert('Owner sign-in required to save.'); return; }
  const month = $('salaryMonth').value; if(!month){ alert('Select month'); return; }

  const rows = Array.from(document.querySelectorAll('#salaryTable tbody tr'));
  const batch = db.batch();

  rows.forEach(tr => {
    const id = tr.querySelector('.sal-amt')?.dataset?.id;
    if(!id) return;
    
    // Read current values from inputs
    const amtPerShift = Number(tr.querySelector('.sal-amt').value) || 0;
    const totalShift = Number(tr.querySelector('.sal-totalShift').value) || 0;
    const totalAmt = Number(tr.querySelector('.sal-totalAmt').value) || 0; // Read calculated value
    const monthlyAdvance = Number(tr.querySelector('.sal-monthlyAdvance').value) || 0; // Read calculated value (from advances)
    const mess = Number(tr.querySelector('.sal-mess').value) || 0;
    const uf = Number(tr.querySelector('.sal-uf').value) || 0;
    const pf = Number(tr.querySelector('.sal-pf').value) || 0;
    const debit = Number(tr.querySelector('.sal-debit').value) || 0;
    const jvc = Number(tr.querySelector('.sal-jvc').value) || 0;
    const other = Number(tr.querySelector('.sal-other').value) || 0;
    const paid = Number(tr.querySelector('.sal-paid').value) || 0; // Read user-overridden or calculated Paid
    const remarks = tr.querySelector('.sal-remarks').value || '';

    const payload = {
  totalShift,
  totalAmt,
  monthlyAdvance,
  mess, uf, pf, debit, jvc, other,
  paid: paid,
  remarks,
  savedAt: firebase.firestore.FieldValue.serverTimestamp()
};

    
    const docId = `${id}_${month}`;
    batch.set(db.collection('salaries').doc(docId), payload, {merge:true});
  });

  try {
    await batch.commit();
    alert('Salary Sheet saved to Firestore.');
  } catch(err){
    alert('Save Salary Sheet failed: ' + err.message);
  }
};


/* Ensure the Show Salary button triggers our function */
$('showSalary').onclick = renderSalarySheet;

/* Build salary table and force a calculation pass so Paid is populated after "Show Salary" */
async function renderSalarySheet(){
  const month = $('salaryMonth').value || $('ownerMonth').value;
  if(!month){ alert('Select month'); return; }

  const labs = await fetchAllLabours();
  const tbody = document.querySelector('#salaryTable tbody');
  tbody.innerHTML = '';

  for(let i=0;i<labs.length;i++){
    const l = labs[i];
    const att = await fetchAttendance(l.id, month);
    const totalShift = Object.values(att.shifts || {}).reduce((s,v)=> s + (Number(v)||0), 0);
    const advItems = await fetchAdvancesForLab(l.id);
    const advTotal = advItems.filter(a=> a.date && a.date.startsWith(month)).reduce((s,x)=> s + (Number(x.amount)||0), 0);
    const saved = await fetchSalary(l.id, month) || {};

    // determine base values (ensure numeric)
   // Always take latest rate from Labour Management
const amtPerShift = Number(l.rate || 0);

    const mess = Number(saved.mess||0), uf = Number(saved.uf||0), pf = Number(saved.pf||0);
    const debit = Number(saved.debit||0), jvc = Number(saved.jvc||0), other = Number(saved.other||0);
    const monthlyAdvance = Number(advTotal || 0);

    // create row — set inputs with 2-decimal formatting so user sees consistent values
    const totalAmt = Number((amtPerShift * totalShift));
   const paidToShow = Number(
  totalAmt
  - monthlyAdvance
  - mess
  - uf
  - pf
  - debit
  - jvc
  - other
);

    const tr = document.createElement('tr');
   tr.innerHTML = `
<td class="sticky-id">${i+1}</td>
<td class="sticky-name">${l.id} - ${l.name}</td>

<td>
  <input class="sal-amt readonly"
         data-id="${l.id}"
         value="${amtPerShift.toFixed(2)}"
         readonly
         style="width:90px;background:#f5f7fb">
</td>

<td>
  <input class="sal-totalShift readonly"
         value="${totalShift.toFixed(2)}"
         readonly
         style="width:90px;background:#f5f7fb">
</td>

<td>
  <input class="sal-totalAmt readonly"
         value="${totalAmt.toFixed(2)}"
         readonly
         style="width:110px;background:#f5f7fb">
</td>

<td>
  <input class="sal-monthlyAdvance readonly"
         value="${monthlyAdvance.toFixed(2)}"
         readonly
         style="width:110px;background:#f5f7fb">
</td>

<td><input class="sal-mess sal-editable" type="number" step="0.01" value="${mess.toFixed(2)}"></td>
<td><input class="sal-uf sal-editable" type="number" step="0.01" value="${uf.toFixed(2)}"></td>
<td><input class="sal-pf sal-editable" type="number" step="0.01" value="${pf.toFixed(2)}"></td>
<td><input class="sal-debit sal-editable" type="number" step="0.01" value="${debit.toFixed(2)}"></td>
<td><input class="sal-jvc sal-editable" type="number" step="0.01" value="${jvc.toFixed(2)}"></td>

<td>
  <input class="sal-other sal-editable"
         type="number"
         step="0.01"
         value="${other.toFixed(2)}">
</td>

<td>
  <input value="${l.paymentMode || 'Cash'}"
         readonly
         style="width:90px;background:#f5f7fb">
</td>

<td>
  <input class="sal-paid readonly"
         value="${paidToShow.toFixed(2)}"
         readonly
         style="width:110px;background:#f5f7fb">
</td>

<td><input class="sal-remarks sal-editable" value="${saved.remarks || ''}"></td>
`;

tbody.appendChild(tr);
  // attach event listeners (recalculate whenever a relevant field changes)
  document.querySelectorAll('#salaryTable input, #salaryTable select').forEach(inp => {
    inp.addEventListener('input', salaryInputsChanged);
    // Add arrow key navigation for all inputs/selects in the salary sheet
    if(inp.classList.contains('sal-editable')) {
      inp.addEventListener('keydown', salaryCellKeyHandler);
    }
  });

  // Force a recalculation pass for every row so Paid column is guaranteed correct after "Show Salary"
  Array.from(document.querySelectorAll('#salaryTable tbody tr')).forEach(row => {
    const amtInput = row.querySelector('.sal-amt');
    if(amtInput) {
      // call the same handler used by user events; this ensures consistent behavior
      salaryInputsChanged({ target: amtInput });
    }
  });
  scrollToElement($('salaryCard'));
}

/* Recalculate a single row's totals and update Paid (called on input and once after render) */
function salaryInputsChanged(e){
  const target = e.target;
  const id = target?.dataset?.id;
  if(!id) return;

  // find the row for this id
  const row = Array.from(document.querySelectorAll('#salaryTable tbody tr'))
    .find(tr => tr.querySelector('.sal-amt')?.dataset.id === id);
  if(!row) return;

  // read numeric inputs (tolerant parsing)
  const amtPerShift = Number(row.querySelector('.sal-amt').value) || 0;
  const totalShift = Number(row.querySelector('.sal-totalShift').value) || 0;
  const monthlyAdvance = Number(row.querySelector('.sal-monthlyAdvance').value) || 0;
  const mess = Number(row.querySelector('.sal-mess').value) || 0;
  const uf = Number(row.querySelector('.sal-uf').value) || 0;
  const pf = Number(row.querySelector('.sal-pf').value) || 0;
  const debit = Number(row.querySelector('.sal-debit').value) || 0;
  const jvc = Number(row.querySelector('.sal-jvc').value) || 0;
  const other = Number(row.querySelector('.sal-other').value) || 0;

  // compute
  const totalAmt = amtPerShift * totalShift;
  const deductions = monthlyAdvance + mess + uf + pf + debit + jvc + other;
  const calcPaid = totalAmt - deductions;

  // write back formatted values
  const totalAmtInp = row.querySelector('.sal-totalAmt');
  if(totalAmtInp) totalAmtInp.value = Number(totalAmt).toFixed(2);

  const paidInp = row.querySelector('.sal-paid');
  if(paidInp){
  paidInp.value = Number(calcPaid).toFixed(2);}


  // ensure amtPerShift remains nicely formatted
  const amtInp = row.querySelector('.sal-amt');
  if(amtInp) amtInp.value = Number(amtPerShift).toFixed(2);
}
}
/* ===== ADVANCES export functions (unchanged behavior) ===== */
async function collectAdvForMonth(month){
  const labs = await fetchAllLabours();
  const rows = [];
  for(const [i,l] of labs.entries()){
    const items = await fetchAdvancesForLab(l.id);
    const filtered = items.filter(a => a.date && a.date.startsWith(month));
    for(const f of filtered){
      rows.push({sno: rows.length+1, id: l.id, name: l.name, date: f.date, amount: Number(f.amount)||0, note: f.note||''});
    }
  }
  return rows;
}
async function exportAdvCSV(){ const month = $('advMonth').value || $('ownerMonth').value; if(!month){ alert('Select month'); return; } const rows = await collectAdvForMonth(month); const header = ['S.No','User ID','Name','Date','Amount','Note']; const csv = [header.join(',')].concat(rows.map(r => [r.sno, r.id, `"${r.name.replace(/"/g,'""')}"`, r.date, Number(r.amount).toFixed(2), `"${(r.note||'').replace(/"/g,'""')}"`].join(','))).join('\n'); downloadBlob(csv, `advances_${month}.csv`, 'text/csv'); }
async function exportAdvXLS(){ const month = $('advMonth').value || $('ownerMonth').value; if(!month){ alert('Select month'); return; } const rows = await collectAdvForMonth(month); let html = '<table border="1"><tr>' + ['S.No','User ID','Name','Date','Amount','Note'].map(h=>`<th>${h}</th>`).join('') + '</tr>'; rows.forEach(r => { html += `<tr><td>${r.sno}</td><td>${r.id}</td><td>${r.name}</td><td>${r.date}</td><td>${Number(r.amount).toFixed(2)}</td><td>${r.note}</td></tr>`; }); html += '</table>'; downloadBlob('\uFEFF'+html, `advances_${month}.xls`, 'application/vnd.ms-excel'); }
async function exportAdvPDF(){ const month = $('advMonth').value || $('ownerMonth').value; if(!month){ alert('Select month'); return; } const rows = await collectAdvForMonth(month); let html = `<html><head><meta charset="utf-8"><title>Advances ${month}</title><style>table{border-collapse:collapse;width:100%}th,td{border:1px solid #333;padding:6px;text-align:center}th{background:#eee}td.left{text-align:left;padding-left:6px}</style></head><body><h2>Advances — ${month}</h2>`; if(rows.length === 0){ html += '<p>No advances for selected month.</p>'; } else { html += '<table><thead><tr><th>S.No</th><th>User ID</th><th>Name</th><th>Date</th><th>Amount</th><th>Note</th></tr></thead><tbody>'; rows.forEach(r => { html += `<tr><td>${r.sno}</td><td>${r.id}</td><td class="left">${r.name}</td><td>${r.date}</td><td style="text-align:right">${Number(r.amount).toFixed(2)}</td><td class="left">${r.note}</td></tr>`; }); html += '</tbody></table>'; const tot = rows.reduce((s,x)=> s + (Number(x.amount)||0), 0); html += `<p><strong>Total: ₹${tot.toFixed(2)}</strong></p>`; } html += '</body></html>'; const blob = new Blob([html], { type: 'text/html' });
const url = URL.createObjectURL(blob);

const a = document.createElement('a');
a.href = url;
a.download = `salary_sheet_${month}.pdf`;
document.body.appendChild(a);
a.click();
a.remove();

URL.revokeObjectURL(url);
 }


/* Attendance Export Functions (IMPLEMENTED) */
async function exportShiftCSV(){
  const month = $('ownerMonth').value; if(!month){ alert('Select month'); return; }
  const { rows, labs } = await collectAttendanceForMonth(month);
  const days = getDays(month);
  const header = ['S.No','User ID','Name'].concat(days).concat(['Total']);

  const csvRows = rows.map(r => {
    let total = 0;
    const shiftValues = days.map(d => {
      const v = Number(r.shifts[d] !== undefined ? r.shifts[d] : 0) || 0;
      total += v;
      return v.toFixed(2); // Format shift values to 2 decimals
    });
    return [r.sno, r.id, `"${r.name.replace(/"/g,'""')}"`].concat(shiftValues).concat([Number(total).toFixed(2)]).join(',');
  });

  const csv = [header.join(',')].concat(csvRows).join('\n');
  downloadBlob(csv, `shifts_${month}.csv`, 'text/csv');
}

async function exportShiftXLS(){
  const month = $('ownerMonth').value; if(!month){ alert('Select month'); return; }
  const { rows, labs } = await collectAttendanceForMonth(month);
  const days = getDays(month);
  let html = '<table border="1"><tr>' + ['S.No','User ID','Name'].concat(days).concat(['Total']).map(h=>`<th>${h}</th>`).join('') + '</tr>';

  rows.forEach(r => {
    let total = 0;
    const shiftCells = days.map(d => {
      const v = Number(r.shifts[d] !== undefined ? r.shifts[d] : 0) || 0;
      total += v;
      return `<td>${v.toFixed(2)}</td>`; // Format shift values to 2 decimals
    }).join('');
    html += `<tr><td>${r.sno}</td><td>${r.id}</td><td>${r.name}</td>${shiftCells}<td>${Number(total).toFixed(2)}</td></tr>`;
  });

  html += '</table>';
  // Use UTF-8 BOM (\uFEFF) to ensure Excel handles UTF-8 correctly
  downloadBlob('\uFEFF'+html, `shifts_${month}.xls`, 'application/vnd.ms-excel');
}

async function exportShiftPDF(){
  const month = $('ownerMonth').value; if(!month){ alert('Select month'); return; }
  const { rows, labs } = await collectAttendanceForMonth(month);
  const days = getDays(month);
  let html = `<html><head><meta charset="utf-8"><title>Shifts ${month}</title><style>table { width:100%; border-collapse:collapse; font-size:10px; }
thead { display: table-header-group; }
tr { page-break-inside: avoid; }
th, td { border:1px solid #333; padding:4px; text-align:center; }
th { background:#eee; }
td.left { text-align:left; padding-left:6px; }
</style></head><body><h2>Labour Shifts — ${month}</h2>`;

  if(rows.length === 0){ html += '<p>No shift data for selected month.</p>'; } else {
    html += '<table><thead><tr><th>S.No</th><th>User ID</th><th>Name</th>' + days.map(d=>`<th>${d}</th>`).join('') + '<th>Total</th></tr></thead><tbody>';
    rows.forEach(r => {
      let total = 0;
      const shiftCells = days.map(d => {
        const v = Number(r.shifts[d] !== undefined ? r.shifts[d] : 0) || 0;
        total += v;
        return `<td>${v.toFixed(2)}</td>`; // Format shift values to 2 decimals
      }).join('');
      html += `<tr><td>${r.sno}</td><td>${r.id}</td><td class="left">${r.name}</td>${shiftCells}<td>${Number(total).toFixed(2)}</td></tr>`;
    });
    html += '</tbody></table>';
  }
  html += '</body></html>';
const blob = new Blob([html], { type: 'text/html' });
const url = URL.createObjectURL(blob);

const a = document.createElement('a');
a.href = url;
a.download = `salary_sheet_${month}.pdf`;
document.body.appendChild(a);
a.click();
a.remove();

URL.revokeObjectURL(url);

}


/* Salary Data Collection Function (IMPLEMENTED) */
async function collectSalaryForMonth(month){
  const labs = await fetchAllLabours();
  const salaryRows = [];

  for(let i=0;i<labs.length;i++){
    const l = labs[i];
    const att = await fetchAttendance(l.id, month);
    const totalShift = Object.values(att.shifts || {}).reduce((s,v)=> s + (Number(v)||0), 0);
    const advItems = await fetchAdvancesForLab(l.id);
    const advTotal = advItems.filter(a=> a.date && a.date.startsWith(month)).reduce((s,x)=> s + (Number(x.amount)||0), 0);
    const saved = await fetchSalary(l.id, month) || {};
    
    // Use saved data if present, otherwise calculate
    const amtPerShift = Number(saved.amtPerShift !== undefined ? saved.amtPerShift : (att.rate || l.rate)) || Number(l.rate||0);
    const mess = Number(saved.mess||0), uf = Number(saved.uf||0), pf = Number(saved.pf||0);
    const debit = Number(saved.debit||0), jvc = Number(saved.jvc||0), other = Number(saved.other||0);
    const monthlyAdvance = Number(advTotal || 0);

    const totalAmt = Number((amtPerShift * totalShift));
    const deductions = monthlyAdvance + mess + uf + pf + debit + jvc + other;
    const paid = saved.paid !== undefined ? Number(saved.paid) : Number(totalAmt - deductions); // Use saved 'paid' if it exists, otherwise calculate

    salaryRows.push({
      sno: i+1,
      id: l.id,
      name: l.name,
      amtPerShift: Number(amtPerShift).toFixed(2),
      totalShift: Number(totalShift).toFixed(2),
      totalAmt: Number(totalAmt).toFixed(2),
      monthlyAdvance: Number(monthlyAdvance).toFixed(2),
      mess: Number(mess).toFixed(2),
      uf: Number(uf).toFixed(2),
      pf: Number(pf).toFixed(2),
      debit: Number(debit).toFixed(2),
      jvc: Number(jvc).toFixed(2),
      other: Number(other).toFixed(2),
      paymentMode: saved.paymentMode || l.paymentMode || 'Cash',
      paidSalary: Number(paid).toFixed(2),
      remarks: saved.remarks || ''
    });
  }
  return salaryRows;
}

/* Salary Export Functions (IMPLEMENTED) */
async function exportSalaryCSV(){
  const month = $('salaryMonth').value || $('ownerMonth').value; if(!month){ alert('Select month'); return; }
  const rows = await collectSalaryForMonth(month);
// 🔁 ORDER: A/c FIRST, Cash AFTER
const acRows = rows.filter(r => r.paymentMode === 'A/c');
const cashRows = rows.filter(r => r.paymentMode !== 'A/c');
const orderedRows = [...acRows, ...cashRows];

  const header = ['S.No','User ID','Name','Amt/Shift','Total Shift','Total Amt','Monthly Advance','Mess','U/F','P/F','Debit','JVC','Other','Payment Mode','Paid Salary','Remarks/Sign'];

  const csvRows = rows.map(r => [
    r.sno, r.id, `"${r.name.replace(/"/g,'""')}"`, r.amtPerShift, r.totalShift, r.totalAmt, r.monthlyAdvance, r.mess, r.uf, r.pf, r.debit, r.jvc, r.other, r.paymentMode, r.paidSalary, `"${r.remarks.replace(/"/g,'""')}"`
  ].join(','));

  const csv = [header.join(',')].concat(csvRows).join('\n');
  downloadBlob(csv, `salary_sheet_${month}.csv`, 'text/csv');
}

async function exportSalaryXLS(){
  const month = $('salaryMonth').value || $('ownerMonth').value; if(!month){ alert('Select month'); return; }
  const rows = await collectSalaryForMonth(month);
// 🔁 ORDER: A/c FIRST, Cash AFTER
const acRows = rows.filter(r => r.paymentMode === 'A/c');
const cashRows = rows.filter(r => r.paymentMode !== 'A/c');
const orderedRows = [...acRows, ...cashRows];

  const header = ['S.No','User ID','Name','Amt/Shift','Total Shift','Total Amt','Monthly Advance','Mess','U/F','P/F','Debit','JVC','Other','Payment Mode','Paid Salary','Remarks/Sign'];

  let html = '<table border="1"><tr>' + header.map(h=>`<th>${h}</th>`).join('') + '</tr>';
  rows.forEach(r => {
    html += `<tr><td>${r.sno}</td><td>${r.id}</td><td>${r.name}</td><td>${r.amtPerShift}</td><td>${r.totalShift}</td><td>${r.totalAmt}</td><td>${r.monthlyAdvance}</td><td>${r.mess}</td><td>${r.uf}</td><td>${r.pf}</td><td>${r.debit}</td><td>${r.jvc}</td><td>${r.other}</td><td>${r.paymentMode}</td><td>${r.paidSalary}</td><td>${r.remarks}</td></tr>`;
  });
  html += '</table>';
  downloadBlob('\uFEFF'+html, `salary_sheet_${month}.xls`, 'application/vnd.ms-excel');
}
async function exportSalaryPDF(){
  const month = $('salaryMonth').value || $('ownerMonth').value;
  if(!month){ alert('Select month'); return; }

  const rows = await collectSalaryForMonth(month);
// 🔁 ORDER: A/c FIRST, Cash AFTER
const acRows = rows.filter(r => r.paymentMode === 'A/c');
const cashRows = rows.filter(r => r.paymentMode !== 'A/c');
const orderedRows = [...acRows, ...cashRows];

  if(rows.length === 0){
    alert('No salary data');
    return;
  }

  const ROWS_PER_PAGE = 30; // SAFE LIMIT
  let pages = [];

 for(let i = 0; i < orderedRows.length; i += ROWS_PER_PAGE){
  pages.push(orderedRows.slice(i, i + ROWS_PER_PAGE));

  }

  let html = `
  <div id="pdfRoot" style="font-family:Arial">
    <style>
<style>
@page {
  size: A4 landscape;
  margin: 0;              /* 🔑 REMOVE browser margins */
}

html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  font-family: Arial, Helvetica, sans-serif;
}

/* WRAPPER TO CONTROL POSITION */
.page {
  width: 297mm;           /* A4 landscape width */
  height: 210mm;          /* A4 landscape height */
  padding: 4mm 2mm 2mm 2mm;  /* top right bottom left */
  box-sizing: border-box;
}

/* TABLE */
table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
  font-size: 8.3px;       /* 🔑 slightly smaller */
  transform: scale(0.986); /* 🔑 shrink to avoid cut */
  transform-origin: top left;
}

th, td {
  border: 1px solid #000;
  padding: 3px 2px;
  text-align: center;
  word-break: break-word;
}

/* HEADER */
th {
  background: #eee;
  font-weight: bold;
}

/* COLUMN WIDTHS (CRITICAL) */
th:nth-child(1),  td:nth-child(1)  { width: 28px; }
th:nth-child(2),  td:nth-child(2)  { width: 45px; }
th:nth-child(3),  td:nth-child(3)  { width: 115px; }
th:nth-child(4),  td:nth-child(4)  { width: 55px; }
th:nth-child(5),  td:nth-child(5)  { width: 55px; }
th:nth-child(6),  td:nth-child(6)  { width: 60px; }
th:nth-child(7),  td:nth-child(7)  { width: 45px; }
th:nth-child(8),  td:nth-child(8)  { width: 45px; }
th:nth-child(9),  td:nth-child(9)  { width: 45px; }
th:nth-child(10), td:nth-child(10) { width: 45px; }
th:nth-child(11), td:nth-child(11) { width: 45px; }
th:nth-child(12), td:nth-child(12) { width: 45px; }
th:nth-child(13), td:nth-child(13) { width: 45px; }
th:nth-child(14), td:nth-child(14) { width: 65px; }
th:nth-child(15), td:nth-child(15) { width: 40px; }
th:nth-child(16), td:nth-child(16) { width: 150px; text-align:left; }

/* PAGE BREAK */
.page-break {
  page-break-after: always;
}
</style>



      th { background:#eee; }
      .page { page-break-after: always; }
    </style>
  `;
pages.forEach((pageRows, pageIndex) => {

  /* Title ONLY on first page */
  if(pageIndex === 0){
    html += `<h2 style="text-align:center">Salary Sheet - ${month}</h2>`;
  }

  html += `
  <div class="page">
    <table>
  ${pageIndex === 0 ? `
<thead>
  <tr>
    <th>S.No</th><th>ID</th><th>Name</th>
    <th>Amt/Shift</th><th>Total Shift</th><th>Total Amt</th>
    <th>Advance</th><th>Mess</th><th>U/F</th><th>P/F</th>
    <th>Debit</th><th>JVC</th><th>Other</th>
    <th>Paid</th><th>A/c</th><th>Remark</th>
  </tr>
</thead>` : ``}
      <tbody>

        ${pageRows.map(r=>`
  <tr>
    <td>${r.sno}</td>
    <td>${r.id}</td>
    <td>${r.name}</td>
    <td>${r.amtPerShift}</td>
    <td>${r.totalShift}</td>
    <td>${r.totalAmt}</td>
    <td>${r.monthlyAdvance}</td>
    <td>${r.mess}</td>
    <td>${r.uf}</td>
    <td>${r.pf}</td>
    <td>${r.debit}</td>
    <td>${r.jvc}</td>
    <td>${r.other}</td>
    <td>${r.paidSalary}</td>
    <td>${r.paymentMode || ''}</td>
    <td>${r.remarks || ''}</td>
  </tr>
`).join('')}

        </tbody>
      </table>
    </div>
    `;
  });

  html += `</div>`;

  const div = document.createElement('div');
  div.innerHTML = html;
  document.body.appendChild(div);

html2pdf()
  .from(div)
  .set({
    margin: [8, 8, 8, 8],
    filename: `salary_sheet_${month}.pdf`,
    jsPDF: { orientation: 'landscape', format: 'a4', unit: 'mm' },
    html2canvas: {
      scale: 1.3,        /* 🔑 DO NOT USE 2 */
      scrollX: 0,
      scrollY: 0,
      windowWidth: 1400  /* 🔑 Forces full table render */
    }
  })
    .save()
    .then(() => div.remove());
}

/* ===== labour management (owner-only) ===== */

/* Drag & drop state */
let reorderEnabled = false;
let originalLabourOrder = []; // hold a copy to cancel if needed

async function renderLabourList(){
  const labs = await fetchAllLabours();
  // store original order snapshot
  originalLabourOrder = labs.map(l => l.id);

  // Build table rows as draggable when reorder is enabled.
  let html = '<table id="labourTable"><thead><tr><th>S.No</th><th>User ID</th><th>Name</th><th>Rate/shift</th><th>Payment Mode</th><th>Actions</th></tr></thead><tbody>';
  labs.forEach((l,i)=>{
    // add draggable-row class only if reorderEnabled is true (we will toggle later)
    html += `<tr class="lab-row draggable-row" data-id="${l.id}" draggable="false"><td class="lab-sno">${i+1}</td><td>${l.id}</td><td class="left">${l.name}</td><td>₹${Number(l.rate).toFixed(2)}</td><td>${l.paymentMode || 'Cash'}</td><td><button onclick="openEditLabour('${l.id}')">Edit</button> <button onclick="deleteLabour('${l.id}')">Delete</button></td></tr>`;
  });
  html += '</tbody></table>';
  $('labourList').innerHTML = html;

  // initialize drag & drop listeners (they will only be active when reorderEnabled = true)
  initDragHandlers();
}

/* enable drag listeners for rows */
function initDragHandlers(){
  const tbody = document.querySelector('#labourList tbody');
  if(!tbody) return;

  // remove any previous listeners by re-cloning nodes (simple cleanup)
  Array.from(tbody.querySelectorAll('.lab-row')).forEach(row => {
    // ensure attributes
    row.draggable = reorderEnabled;
    row.classList.toggle('draggable-row', reorderEnabled);
    row.classList.remove('dragging','drop-target');
  });

  if(!reorderEnabled) return;

  let dragSrc = null;

  tbody.addEventListener('dragstart', e => {
    const tr = e.target.closest('tr.lab-row');
    if(!tr) return;
    dragSrc = tr;
    tr.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    try { e.dataTransfer.setData('text/plain', tr.dataset.id); } catch(_) {}
  });

  tbody.addEventListener('dragend', e => {
    const tr = e.target.closest('tr.lab-row');
    if(tr) tr.classList.remove('dragging');
    tbody.querySelectorAll('.drop-target').forEach(el => el.classList.remove('drop-target'));
  });

  tbody.addEventListener('dragover', e => {
    e.preventDefault();
    const tr = e.target.closest('tr.lab-row');
    if(!tr || tr === dragSrc) return;
    tr.classList.add('drop-target');
  });

  tbody.addEventListener('dragleave', e => {
    const tr = e.target.closest('tr.lab-row');
    if(tr) tr.classList.remove('drop-target');
  });

  tbody.addEventListener('drop', e => {
    e.preventDefault();
    const tr = e.target.closest('tr.lab-row');
    if(!tr || !dragSrc || tr === dragSrc) return;
    // insert dragged row before or after target depending on pointer position
    const rect = tr.getBoundingClientRect();
    const dropBefore = (e.clientY - rect.top) < (rect.height / 2);
    const parent = tbody;
    if(dropBefore) parent.insertBefore(dragSrc, tr);
    else parent.insertBefore(dragSrc, tr.nextSibling);

    // update S.No
    Array.from(parent.querySelectorAll('tr.lab-row')).forEach((r, idx) => {
      const snoCell = r.querySelector('.lab-sno');
      if(snoCell) snoCell.textContent = idx + 1;
    });
  });
}

/* Buttons to control reorder */
$('enableReorder').onclick = async () => {
  reorderEnabled = true;
  // show Fix and Cancel buttons
  $('fixOrderBtn').classList.remove('hidden');
  $('cancelReorderBtn').classList.remove('hidden');
  $('enableReorder').classList.add('hidden');
  // make rows draggable and add visual hint
  Array.from(document.querySelectorAll('#labourList tr.lab-row')).forEach(r => {
    r.draggable = true;
    r.classList.add('draggable-row');
  });
  initDragHandlers();
  // small scroll to labour list
  scrollToElement($('labourList'));
};

$('cancelReorderBtn').onclick = async () => {
  // revert DOM to original order by re-rendering
  reorderEnabled = false;
  $('fixOrderBtn').classList.add('hidden');
  $('cancelReorderBtn').classList.add('hidden');
  $('enableReorder').classList.remove('hidden');
  await renderLabourList(); // this re-loads from Firestore (original or persisted order)
};

$('fixOrderBtn').onclick = async () => {
  if(!isOwnerSignedIn()){ alert('Owner sign-in required to save order.'); return; }
  const rows = Array.from(document.querySelectorAll('#labourList tbody tr.lab-row'));
  // compute new order array
  const newOrder = rows.map((r, idx) => ({ id: r.dataset.id, order: idx + 1 }));
  try {
    // write in batch to Firestore
    const batch = db.batch();
    newOrder.forEach(item => {
      const ref = db.collection('labours').doc(item.id);
      batch.set(ref, { order: item.order }, { merge: true });
    });
    await batch.commit();
    alert('Order saved.');
    reorderEnabled = false;
    $('fixOrderBtn').classList.add('hidden');
    $('cancelReorderBtn').classList.add('hidden');
    $('enableReorder').classList.remove('hidden');
    // re-render all dependent views
    await renderLabourList();
    await generateOwnerTable(false); // don't scroll to top, keep focus on list
    await populateAdvSelect();
    // No need to render salary/advances, they pull the order dynamically when active
  } catch (err) {
    alert('Failed to save order: ' + err.message);
  }
};

/* modal and CRUD unchanged */
$('addLabour').onclick = ()=> openLabourModal();

function openLabourModal(editId){
  $('labourModal').classList.remove('hidden');
  if(editId){
    fetchLabourById(editId).then(lab=>{
      $('labourModalTitle').textContent = 'Edit Labour';
      $('modalUserId').value = lab.id; $('modalName').value = lab.name; $('modalPwd').value = lab.password; $('modalRate').value = lab.rate;
      $('modalPayMode').value = lab.paymentMode || 'Cash';
      $('labourModal').dataset.edit = editId;
      scrollToElement($('labourModal'));
    }).catch(()=>{ alert('Failed to fetch labour'); });
  } else {
    $('labourModalTitle').textContent = 'Add Labour';
    $('modalUserId').value=''; $('modalName').value=''; $('modalPwd').value='1234'; $('modalRate').value='500';
    $('modalPayMode').value = 'Cash';
    delete $('labourModal').dataset.edit;
    scrollToElement($('labourModal'));
  }
}
function openEditLabour(id){ openLabourModal(id); }
$('cancelLabourBtn').onclick = ()=> { $('labourModal').classList.add('hidden'); scrollToTop(); };

$('saveLabourBtn').onclick = async ()=>{
  if(!isOwnerSignedIn()){ alert('Owner sign-in required'); return; }
  const id=$('modalUserId').value.trim(), name=$('modalName').value.trim(), pwd=$('modalPwd').value.trim(), rate=Number($('modalRate').value)||0;
  const paymentMode = $('modalPayMode').value || 'Cash';
  if(!id||!name){ alert('Enter ID and name'); return; }
  try{
    await saveLabourToFirestore({id, name, password: pwd, rate, paymentMode});
    $('labourModal').classList.add('hidden'); await renderLabourList(); await generateOwnerTable(false); await populateAdvSelect(); 
    // Do not call renderSalarySheet/renderAdvances, they will load the new labour when the user switches tabs
    alert('Saved');
    scrollToTop();
  } catch(err){ alert('Save failed: ' + err.message); }
};

async function deleteLabour(id){
  if(!isOwnerSignedIn()){ alert('Owner sign-in required to delete labour.'); return; }
  if(!confirm('Delete labour and all data?')) return;
  try{
    await deleteLabourFromFirestore(id);
    await renderLabourList(); await generateOwnerTable(false); // Don't scroll
    // Do not call renderSalarySheet/renderAdvances, they will reflect the deleted labour when the user switches tabs
    alert('Deleted ' + id);
  } catch(err){ alert('Delete failed: ' + err.message); }
}

/* ===== Labour UI (view only) ===== */
function renderLabourInfo(){ if(!currentLabour) return; $('labourInfo').innerHTML = `<p><strong>${currentLabour.name}</strong> (ID: ${currentLabour.id})</p>`; }
async function renderLabourView(){
  if(!currentLabour) return; const month = $('labourMonth').value; if(!month) return;
  const rec = await fetchAttendance(currentLabour.id, month);
  const days = getDays(month);
  let html = '<h3>Attendance</h3><table><thead><tr><th>Date</th><th>Shifts</th></tr></thead><tbody>';
  let total = 0;
  days.forEach(d=>{ const v = Number(rec.shifts && rec.shifts[d] !== undefined ? rec.shifts[d] : 0) || 0; html += `<tr><td class="left">${d}</td><td>${v.toFixed(2)}</td></tr>`; total += v; });
  html += `</tbody></table><p class="small">Total shifts: ${total.toFixed(2)}</p>`;
  $('labourAttendance').innerHTML = html;

  const advItemsAll = await fetchAdvancesForLab(currentLabour.id);
  const advList = advItemsAll.filter(a=> a.date && a.date.startsWith(month)).sort((a,b)=> a.date < b.date ? -1 : (a.date > b.date ? 1 : 0));
  let advHtml = '<h3>Advances</h3>';
  if(!advList.length) advHtml += '<p class="small">No advances for month</p>'; else { advHtml += '<table><thead><tr><th>Date</th><th>Amount</th><th>Note</th></tr></thead><tbody>'; advList.slice().reverse().forEach(a=> advHtml += `<tr><td>${a.date}</td><td style="text-align:right">₹${Number(a.amount).toFixed(2)}</td><td class="left">${a.note||''}</td></tr>`); advHtml += '</tbody></table>'; advHtml += `<p class="small"><strong>Total: ₹${advList.reduce((s,x)=> s + (Number(x.amount)||0),0).toFixed(2)}</strong></p>`; }
  $('labourAdvance').innerHTML = advHtml;

  const saved = await fetchSalary(currentLabour.id, month) || {};
  const amtPerShift = Number(saved.amtPerShift !== undefined ? saved.amtPerShift : (rec.rate||currentLabour.rate)) || currentLabour.rate;
  const totalShift = Object.values(rec.shifts||{}).reduce((s,v)=> s + (Number(v)||0), 0);
  const totalAmt = Number((amtPerShift * totalShift).toFixed(2));
  const advTotal = advList.reduce((s,x)=> s + (Number(x.amount)||0), 0);
  const mess = Number(saved.mess||0), uf = Number(saved.uf||0), pf = Number(saved.pf||0), debit = Number(saved.debit||0), jvc = Number(saved.jvc||0), other = Number(saved.other||0);
  const deductions = Number((advTotal + mess + uf + pf + debit + jvc + other).toFixed(2));
  const paidCalculated = Number((totalAmt - deductions).toFixed(2));
  let salaryHtml = `<h3>Salary — ${month}</h3>`;
  salaryHtml += `<table><tbody>`;
  salaryHtml += `<tr><td class="left">Amt/Shift</td><td>₹${Number(amtPerShift).toFixed(2)}</td></tr>`;
  salaryHtml += `<tr><td class="left">Total Shift</td><td>${Number(totalShift).toFixed(2)}</td></tr>`;
  salaryHtml += `<tr><td class="left">Total Amount</td><td>₹${totalAmt}</td></tr>`;
  salaryHtml += `<tr><td class="left">Monthly Advance (sum of advances)</td><td>₹${Number(advTotal).toFixed(2)}</td></tr>`;
  salaryHtml += `<tr><td class="left">Mess</td><td>₹${Number(mess).toFixed(2)}</td></tr>`;
  salaryHtml += `<tr><td class="left">U/F</td><td>₹${Number(uf).toFixed(2)}</td></tr>`;
  salaryHtml += `<tr><td class="left">P/F</td><td>₹${Number(pf).toFixed(2)}</td></tr>`;
  salaryHtml += `<tr><td class="left">Debit</td><td>₹${Number(debit).toFixed(2)}</td></tr>`;
  salaryHtml += `<tr><td class="left">JVC</td><td>₹${Number(jvc).toFixed(2)}</td></tr>`;
  salaryHtml += `<tr><td class="left">Other</td><td>₹${Number(other).toFixed(2)}</td></tr>`;
  salaryHtml += `<tr><td class="left"><strong>Paid (calculated)</strong></td><td><strong>₹${paidCalculated}</strong></td></tr>`;
  salaryHtml += `<tr><td class="left">Paid (owner saved)</td><td>${saved.paid !== undefined ? '₹'+Number(saved.paid).toFixed(2) : '—'}</td></tr>`;
  salaryHtml += `</tbody></table>`;
  $('labourSalary').innerHTML = salaryHtml;
}

/* ===== Ownership/sign-in guard ===== */
function isOwnerSignedIn(){
  const user = auth.currentUser;
  return user && user.uid === OWNER_UID;
}
auth.onAuthStateChanged(user => {
  if(user) $('ownerAuthMsg').textContent = 'Signed in as UID: ' + user.uid;
  else $('ownerAuthMsg').textContent = '';
});

/* ===== Utility functions ===== */
function daysInMonth(y,m){ return new Date(y,m,0).getDate(); }
function getDays(monthStr){ const [y,m] = monthStr.split('-').map(Number); const n = daysInMonth(y,m); const arr=[]; for(let d=1; d<=n; d++) arr.push(d); return arr; }
function getRateForLabour(id){ return 0; }

/* Arrow key handler for attendance cells:
   - Arrow left/right moves within same row
   - Arrow up/down moves to same column previous/next visible row
   - TAB/ENTER moves to search box
*/
function attCellKeyHandler(e){
  // 1. Tab/Enter: Auto-return to search box
  if(e.key === 'Enter' || e.key === 'Tab'){ 
    e.preventDefault(); 
    updateRowTotals();
    // Move to the search box
    $('ownerSearch').focus();
    return;
  }

  // Check if target is an attendance cell
  const el = e.target;
  if(!el.classList.contains('attCell')) return;
  
  const tr = el.closest('tr');
  if(!tr) return;
  const cells = Array.from(tr.querySelectorAll('.attCell'));
  const idx = cells.indexOf(el);

  // 2. Left/Right Navigation
  if(e.key === 'ArrowRight'){ e.preventDefault(); if(idx < cells.length -1) cells[idx+1].focus(); }
  else if(e.key === 'ArrowLeft'){ e.preventDefault(); if(idx > 0) cells[idx-1].focus(); }
  
  // 3. Up/Down Navigation
  else if(e.key === 'ArrowDown' || e.key === 'ArrowUp'){ 
    e.preventDefault(); // <-- CRITICAL to stop browser default movement
    
    const allRows = Array.from(document.querySelectorAll('#ownerTable tbody tr'));
    
    // Filter for currently visible rows using computed style
    const visibleRows = allRows.filter(r => window.getComputedStyle(r).display !== 'none');
    
    const rIdx = visibleRows.indexOf(tr); // index within visible rows
    
    let nextRow = null;
    if(e.key === 'ArrowDown' && rIdx < visibleRows.length - 1){
      nextRow = visibleRows[rIdx+1];
    } else if(e.key === 'ArrowUp' && rIdx > 0){
      nextRow = visibleRows[rIdx-1];
    }

    if(nextRow){
      // Get the cell at the same index (same date column)
      const nextCell = nextRow.querySelectorAll('.attCell')[idx]; 
      if(nextCell) nextCell.focus();
    } else {
        // If at the end/beginning of the filtered list, return to search box
        $('ownerSearch').focus();
    }
  }
}

/* Arrow key handler for salary sheet cells:
   - Moves only between the cells with the class 'sal-editable'
*/
function salaryCellKeyHandler(e){
  const el = e.target;
  // Use a generalized selector for all editable/navigable elements within the table
  const allEditable = Array.from(document.querySelectorAll('#salaryTable .sal-editable'));
  const currentIdx = allEditable.indexOf(el);

  if(currentIdx === -1) return; // Should not happen if event listener is only on sal-editable

  const tr = el.closest('tr');
  if(!tr) return;

  const editableInRow = Array.from(tr.querySelectorAll('.sal-editable'));
  const idxInRow = editableInRow.indexOf(el);

  if(e.key === 'ArrowRight'){
    e.preventDefault();
    if(currentIdx < allEditable.length - 1) allEditable[currentIdx + 1].focus();
  } else if(e.key === 'ArrowLeft'){
    e.preventDefault();
    if(currentIdx > 0) allEditable[currentIdx - 1].focus();
  } else if(e.key === 'ArrowDown'){
    e.preventDefault();
    const rows = Array.from(document.querySelectorAll('#salaryTable tbody tr'));
    const rIdx = rows.indexOf(tr);
    if(rIdx < rows.length - 1){
      const nextRow = rows[rIdx + 1];
      const nextRowEditable = Array.from(nextRow.querySelectorAll('.sal-editable'));
      // Find the element at the same column index (idxInRow) in the next row
      const next = nextRowEditable[idxInRow];
      if(next) next.focus();
    }
  } else if(e.key === 'ArrowUp'){
    e.preventDefault();
    const rows = Array.from(document.querySelectorAll('#salaryTable tbody tr'));
    const rIdx = rows.indexOf(tr);
    if(rIdx > 0){
      const prevRow = rows[rIdx - 1];
      const prevRowEditable = Array.from(prevRow.querySelectorAll('.sal-editable'));
      // Find the element at the same column index (idxInRow) in the previous row
      const prev = prevRowEditable[idxInRow];
      if(prev) prev.focus();
    }
  }
}


/* utility to download files */
function downloadBlob(content, filename, mime){ const blob = new Blob([content], {type:mime}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

/* export full data backup (new) */
$('exportBackup').onclick = async ()=>{
  if(!isOwnerSignedIn()){ alert('Owner sign-in required to export data.'); return; }
  if(!confirm('This will export ALL data (Labours, Attendance, Advances, Salaries) from Firestore. Proceed?')) return;

  try {
    const backup = {
      labours: {},
      attendance: {},
      advances: {},
      salaries: {}
    };

    const labourSnap = await db.collection('labours').get();
    labourSnap.docs.forEach(d => backup.labours[d.id] = d.data());

    const attSnap = await db.collection('attendance').get();
    attSnap.docs.forEach(d => backup.attendance[d.id] = d.data());

    const advSnap = await db.collection('advances').get();
    advSnap.docs.forEach(d => backup.advances[d.id] = d.data());

    const salSnap = await db.collection('salaries').get();
    salSnap.docs.forEach(d => backup.salaries[d.id] = d.data());
    
    const jsonStr = JSON.stringify(backup, null, 2);
    downloadBlob(jsonStr, `labour_portal_backup_${(new Date()).toISOString().slice(0,10)}.json`, 'application/json');
    alert('Full backup exported successfully.');

  } catch(err) {
    alert('Backup failed: ' + err.message);
    console.error(err);
  }
};


/* AUTO-SELECT text when clicking in search boxes and login id */
['ownerSearch', 'advSearch', 'labUserId'].forEach(id=>{
  const el = document.getElementById(id);
  if(el){
    el.addEventListener('focus', function(){
      setTimeout(()=> this.select(), 10);
    });
  }
});

/* wire export buttons */
$('exportShiftCSV').onclick = exportShiftCSV;
$('exportShiftXLS').onclick = exportShiftXLS;
$('exportShiftPDF').onclick = exportShiftPDF;
$('exportSalaryCSV').onclick = exportSalaryCSV;
$('exportSalaryXLS').onclick = exportSalaryXLS;
$('exportSalaryPDF').onclick = exportSalaryPDF;
$('exportAdvCSV').onclick = exportAdvCSV;
$('exportAdvXLS').onclick = exportAdvXLS;
$('exportAdvPDF').onclick = exportAdvPDF;

/* init on load - we only call renderLabourList and populateAdvSelect here as initOwnerView handles the first tab switch */
window.addEventListener('load', async ()=>{ 
  try{ 
    await renderLabourList(); 
    await populateAdvSelect(); 
  }catch(e){ 
    console.warn('Init load: ', e.message); 
  } 
});


</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</body>
</html>





