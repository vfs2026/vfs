<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Labour Shift, Advance & Salary Portal (Firestore)</title>
<style>
  :root{--sticky-id:100px;--sticky-name:260px}
  body{font-family:Arial,Helvetica,sans-serif;background:#f5f7fb;margin:0;color:#222}
  .wrap{max-width:1200px;margin:18px auto;padding:14px}
  .card{background:#fff;border-radius:10px;padding:14px;margin-bottom:12px;box-shadow:0 6px 20px rgba(20,20,40,0.05)}
  h1{margin:6px 0 12px;font-size:20px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  input,select,button,textarea{font-size:14px;padding:8px;border-radius:8px;border:1px solid #d6e0ef}
  button{cursor:pointer}
  .btn{background:#0b79ff;color:#fff;border:none}
  .btn-muted{background:#6c757d;color:#fff;border:none}
  .success{background:#28a745;color:#fff;border:none}
  .danger{background:#dc3545;color:#fff;border:none}
  table{border-collapse:collapse;width:100%;font-size:13px}
  th,td{border:1px solid #e8eef8;padding:6px;text-align:center;white-space:nowrap}
  th{background:#f3f8ff}
  .small{font-size:12px;color:#555}
  .muted{color:#666}
  .hidden{display:none}
  .table-wrap{overflow:auto;background:#fff;padding:8px;border-radius:8px}
  table thead th.sticky-id, table tbody td.sticky-id{ position:sticky; left:0; background:#fff; z-index:4; min-width:var(--sticky-id) }
  table thead th.sticky-name, table tbody td.sticky-name{ position:sticky; left:var(--sticky-id); background:#fff; z-index:3; min-width:var(--sticky-name); text-align:left; padding-left:10px }
  .readonly{background:#f6f8fb}
  .left { text-align:left; padding-left:6px }
  @media (max-width:1100px){ :root{--sticky-name:160px} }
  .controls{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .search{width:260px}
  /* small helpers for export preview */
  .export-hidden { display:block; width:100%; }
</style>
</head>
<body>
<div class="wrap">
  <div class="card" id="homeCard">
    <h1>Labour Shift, Advance & Salary Portal (Firestore)</h1>
    <div class="row">
      <button class="btn" id="ownerBtn">Owner Login</button>
      <button class="btn-muted" id="labourBtn">Labour Login</button>
      <div style="flex:1"></div>
    </div>
    <p class="small muted">Owner must sign in to perform saves (Firestore writes).</p>
  </div>

  <!-- Owner Login (email/password using Firebase Auth) -->
  <div class="card hidden" id="ownerLoginCard">
    <h3>Owner Login (Firebase)</h3>
    <label>Email</label><br>
    <input id="ownerEmail" type="email" placeholder="owner@example.com" autocomplete="off"><br>
    <label>Password</label><br>
    <input id="ownerPassword" type="password" placeholder="password" autocomplete="off">
    <div style="margin-top:10px">
      <button class="btn" id="ownerLogin">Sign In</button>
      <button id="ownerBack">Back</button>
    </div>
    <div id="ownerAuthMsg" class="small muted" style="margin-top:8px"></div>
  </div>

  <!-- Labour Login (ID only) -->
  <div class="card hidden" id="labourLoginCard">
    <h3>Labour Login (ID only)</h3>
    <label>User ID</label><br>
    <input id="labUserId" placeholder="L001" autocomplete="off">
    <div style="margin-top:10px">
      <button class="btn" id="labourLoginBtn">Login</button>
      <button id="labourBack">Back</button>
    </div>
    <p class="small muted">Labour login requires only User ID — no password shown to labour.</p>
  </div>

  <!-- Owner Dashboard -->
  <div class="card hidden" id="ownerDashboard">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h2>Owner Dashboard</h2>
      <div><button id="ownerLogout">Sign Out</button></div>
    </div>

    <div class="controls">
      <label>Month</label>
      <input type="month" id="ownerMonth">
      <button class="btn" id="loadTable">Load Table</button>
      <button id="addLabour">Add Labour</button>
      <button id="exportBackup">Export Backup (local snapshot)</button>
      <div style="flex:1"></div>
      <label>Search</label>
      <input id="ownerSearch" class="search" placeholder="ID or name" oninput="ownerFilter()">
      <button class="success" id="saveAll">Save All (to Firestore)</button>
      <button id="exportShiftCSV">Export Shifts CSV</button>
      <button id="exportShiftXLS">Export Shifts XLS</button>
      <button id="exportShiftPDF">Export Shifts PDF</button>
    </div>

    <div id="ownerTableWrap" class="table-wrap card"></div>

    <div class="card" id="advancesCard" style="margin-top:12px">
      <h3>Advances</h3>
      <div style="display:flex;align-items:center;gap:8px">
        <label>Month</label><input type="month" id="advMonth">
        <button id="showAdv">Show</button>
        <div style="flex:1"></div>
        <!-- new advance export buttons -->
        <button id="exportAdvCSV">Export Adv CSV</button>
        <button id="exportAdvXLS">Export Adv XLS</button>
        <button id="exportAdvPDF">Export Adv PDF</button>
      </div>
      <div style="display:flex;gap:12px;margin-top:12px">
        <div style="flex:1">
          <table id="advTable"><thead><tr><th>S.No</th><th>ID</th><th>Name</th><th>Total (₹)</th><th>Actions</th></tr></thead><tbody></tbody></table>
        </div>
        <div style="width:360px" id="advPanel">
          <h4>Add Advance</h4>
          <label>Labour (search)</label>
          <input id="advLabInput" list="advList" placeholder="Type id or name" style="width:100%" autocomplete="off">
          <datalist id="advList"></datalist>
          <label>Date</label><input id="advDate" type="date">
          <label>Amount (₹)</label><input id="advAmt" type="number" min="0" step="0.01">
          <label>Note</label><textarea id="advNote" rows="3" style="width:100%"></textarea>
          <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
            <button class="btn" id="saveAdv">Save Advance</button>
            <button id="clearAdv">Clear</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card" id="salaryCard" style="margin-top:12px">
      <h3>Salary Sheet</h3>
      <div style="display:flex;gap:8px;align-items:center">
        <label>Month</label>
        <input type="month" id="salaryMonth">
        <button id="showSalary">Show Salary</button>
        <div style="flex:1"></div>
        <button class="success" id="saveSalary">Save Salary Sheet</button>
        <button id="exportSalaryCSV">Download Salary CSV</button>
        <button id="exportSalaryXLS">Download Salary XLS</button>
        <button id="exportSalaryPDF">Download Salary PDF</button>
      </div>
      <div class="table-wrap" style="margin-top:10px">
        <table id="salaryTable"><thead><tr>
          <th class="sticky-id">S.No</th><th class="sticky-name">User ID - Name</th>
          <th>Amt/Shift</th><th>Total Shift</th><th>Total Amt</th>
          <th>Monthly Advance</th><th>Mess</th><th>U/F</th><th>P/F</th><th>Debit</th><th>JVC</th><th>Other</th><th>Payment Mode</th><th>Paid Salary</th><th>Remarks/Signature</th>
        </tr></thead><tbody></tbody></table>
      </div>
      <p class="small muted">Paid = TotalAmt − (MonthlyAdvance + Mess + U/F + P/F + Debit + JVC + Other). Owner may override Paid before saving.</p>
    </div>

    <hr>
    <h3 class="small">Manage Labours</h3>
    <div id="labourList"></div>
  </div>

  <!-- Labour Dashboard -->
  <div class="card hidden" id="labourDashboard">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h2>Labour Portal</h2>
      <div><button id="labourLogout">Back</button></div>
    </div>
    <div id="labourInfo"></div>
    <label>Select Month</label>
    <input type="month" id="labourMonth" onchange="renderLabourView()">
    <div id="labourAttendance" class="card" style="margin-top:8px"></div>
    <div id="labourAdvance" class="card" style="margin-top:8px"></div>
    <div id="labourSalary" class="card" style="margin-top:8px"></div>
  </div>

  <!-- Modal: Add/Edit Labour -->
  <div class="card hidden" id="labourModal">
    <h3 id="labourModalTitle">Add Labour</h3>
    <label>User ID</label><input id="modalUserId"><br>
    <label>Name</label><input id="modalName"><br>
    <label>Password</label><input id="modalPwd"><br>
    <label>Rate per shift (₹)</label><input id="modalRate" type="number" min="0" step="0.01"><br>
    <!-- NEW: Payment mode -->
    <label>Payment Mode</label>
    <select id="modalPayMode" style="width:120px">
      <option value="Cash">Cash</option>
      <option value="A/c">A/c</option>
    </select>
    <div style="margin-top:10px">
      <button class="btn" id="saveLabourBtn">Save</button>
      <button id="cancelLabourBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- CDNs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<!-- html2canvas + jsPDF for reliable client-side PDF generation and auto-download -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNa5cK5s2p3P6qzXptB2IYpW4l8lXQk2nY3F+miLAf7kGBwZQYq6c+o8FTiF0y2q5ZqQx7kI0s+K3Wl3o5p5Yg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-EZND0q2K5h4q1z6sK1bEo3v9d7k5F0v9Q6dW9xPzXQ1c8jK8h7o2Yq8E6p9Y9tV4aQ1R6Yq3P3g7u9h1sQx2w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
/* ---------------------------
  Firebase config (your provided config)
---------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyD4Ax31xHSiW4d4j-YgwcmvH1kPc4OrUoU",
  authDomain: "vfs-labour-portal-8ba3c.firebaseapp.com",
  projectId: "vfs-labour-portal-8ba3c",
  storageBucket: "vfs-labour-portal-8ba3c.firebasestorage.app",
  messagingSenderId: "212643125844",
  appId: "1:212643125844:web:ff2757e75fd37203fc6bc1",
  measurementId: "G-1SF18YYT6P"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* OWNER UID — keep your UID here */
const OWNER_UID = 'D0iiwtC6w9O9qImWLQUXDxKP7lc2';

/* DOM helper */
const $ = id => document.getElementById(id);

/* ---------- Navigation ---------- */
function hideAll(){ ['ownerLoginCard','labourLoginCard','ownerDashboard','labourDashboard','labourModal'].forEach(id=>$(id).classList.add('hidden')); $('homeCard').classList.add('hidden'); }
$('ownerBtn').onclick = ()=>{ hideAll(); $('ownerLoginCard').classList.remove('hidden'); scrollToTopSmooth(); };
$('labourBtn').onclick = ()=>{ hideAll(); $('labourLoginCard').classList.remove('hidden'); scrollToTopSmooth(); };
$('ownerBack').onclick = ()=>location.reload();
$('labourBack').onclick = ()=>location.reload();

/* ---------- Auth ---------- */
$('ownerLogin').onclick = async ()=>{
  const email = $('ownerEmail').value.trim();
  const pwd = $('ownerPassword').value.trim();
  if(!email || !pwd){ alert('Enter email and password'); return; }
  try{
    const userCred = await auth.signInWithEmailAndPassword(email, pwd);
    const uid = userCred.user.uid;
    $('ownerAuthMsg').textContent = 'Signed in UID: ' + uid;
    if(uid !== OWNER_UID) {
      alert('Signed in UID does not match OWNER_UID variable. Update OWNER_UID in code or use the owner with that UID.');
    }
    hideAll(); $('ownerDashboard').classList.remove('hidden'); await initOwnerView(); scrollToTopSmooth();
  } catch(err){
    alert('Sign in failed: ' + err.message);
  }
};
$('ownerLogout').onclick = async ()=>{ await auth.signOut(); location.reload(); };

/* ---------- Labour login ---------- */
let currentLabour = null;
$('labourLoginBtn').onclick = async ()=>{
  const id = $('labUserId').value.trim();
  if(!id){ alert('Enter your User ID'); return; }
  try {
    const labDoc = await db.collection('labours').doc(id).get();
    if(!labDoc.exists){
      alert('User ID not found in Firestore. Create labour as owner first.');
      return;
    }
    currentLabour = labDoc.data();
    currentLabour.id = labDoc.id;
    hideAll(); $('labourDashboard').classList.remove('hidden');
    $('labourMonth').value = (new Date()).toISOString().slice(0,7);
    renderLabourInfo(); renderLabourView();
    scrollToTopSmooth();
  } catch(err){
    alert('Error fetching labour: ' + err.message);
  }
};
$('labourLogout').onclick = ()=> location.reload();

/* ========== Firestore helpers (updated ordering) ========== */

/* Fetch labours ordered by createdAt asc (older first). If createdAt absent, fallback to id ordering. */
async function fetchAllLabours(){
  try {
    const snap = await db.collection('labours').orderBy('createdAt', 'asc').get();
    return snap.docs.map(d => ({ id: d.id, ...d.data() }));
  } catch (e) {
    // fallback: some docs missing createdAt; get all and sort client-side by createdAt then by id
    const snap = await db.collection('labours').get();
    const arr = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    arr.sort((a,b) => {
      const ta = a.createdAt ? a.createdAt.toMillis?.() || (a.createdAt.seconds*1000) : 0;
      const tb = b.createdAt ? b.createdAt.toMillis?.() || (b.createdAt.seconds*1000) : 0;
      if(ta && tb) return ta - tb;
      if(ta && !tb) return -1;
      if(!ta && tb) return 1;
      return (a.id||'').localeCompare(b.id||'');
    });
    return arr;
  }
}

async function fetchLabourById(id){
  const d = await db.collection('labours').doc(id).get();
  if(!d.exists) return null;
  return {id: d.id, ...d.data()};
}

/* Save labour: if new, add serverTimestamp createdAt (so new items go to bottom) */
async function saveLabourToFirestore(lab){
  const ref = db.collection('labours').doc(lab.id);
  const snap = await ref.get();
  if (snap.exists) {
    await ref.set({
      name: lab.name || '',
      password: lab.password || '',
      rate: Number(lab.rate) || 0,
      paymentMode: lab.paymentMode || 'Cash'
    }, { merge: true });
  } else {
    await ref.set({
      id: lab.id,
      name: lab.name || '',
      password: lab.password || '',
      rate: Number(lab.rate) || 0,
      paymentMode: lab.paymentMode || 'Cash',
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  }
}

async function deleteLabourFromFirestore(id){
  await db.collection('labours').doc(id).delete();
  const attAll = await db.collection('attendance').get();
  const batch = db.batch();
  attAll.docs.forEach(doc => { if(doc.id.startsWith(id + '_')) batch.delete(doc.ref); });
  const advDoc = db.collection('advances').doc(id);
  batch.delete(advDoc);
  const salAll = await db.collection('salaries').get();
  salAll.docs.forEach(doc => { if(doc.id.startsWith(id + '_')) batch.delete(doc.ref); });
  await batch.commit();
}

/* Attendance */
async function fetchAttendance(labId, month){
  const id = `${labId}_${month}`;
  const d = await db.collection('attendance').doc(id).get();
  return d.exists ? d.data() : {shifts:{}, rate: null};
}
async function saveAttendanceForMonth(attObjMap){
  const batch = db.batch();
  for(const key of Object.keys(attObjMap)){
    batch.set(db.collection('attendance').doc(key), attObjMap[key], {merge:true});
  }
  await batch.commit();
}

/* Advances */
async function fetchAdvancesForLab(labId){
  const d = await db.collection('advances').doc(labId).get();
  return d.exists ? (d.data().items || []) : [];
}
async function appendAdvanceForLab(labId, advanceItem){
  const ref = db.collection('advances').doc(labId);
  await ref.set({ items: firebase.firestore.FieldValue.arrayUnion(advanceItem) }, {merge:true});
}

/* Salaries */
async function fetchSalary(labId, month){
  const id = `${labId}_${month}`;
  const d = await db.collection('salaries').doc(id).get();
  return d.exists ? d.data() : null;
}
async function saveSalaryRecord(labId, month, payload){
  const id = `${labId}_${month}`;
  await db.collection('salaries').doc(id).set(payload, {merge:true});
}

/* ---------- Small helpers ---------- */
function scrollToTopSmooth(){ window.scrollTo({top:0, behavior:'smooth'}); }
function scrollToElemSmooth(el){ if(!el) return; el.scrollIntoView({behavior:'smooth', block:'center'}); }

/* ---------- Owner UI init ---------- */
async function initOwnerView(){
  $('ownerMonth').value = (new Date()).toISOString().slice(0,7);
  $('advMonth').value = $('ownerMonth').value;
  $('salaryMonth').value = $('ownerMonth').value;
  await generateOwnerTable();
  await renderLabourList();
  await populateAdvSelect();
  await renderAdvances();
  await renderSalarySheet();
}

/* ---------- Attendance table generation ---------- */
function daysInMonth(y,m){ return new Date(y,m,0).getDate(); }
function getDays(monthStr){ const [y,m] = monthStr.split('-').map(Number); const n = daysInMonth(y,m); const arr=[]; for(let d=1; d<=n; d++) arr.push(d); return arr; }

async function generateOwnerTable(){
  const month = $('ownerMonth').value; if(!month){ alert('Select month'); return; }
  const days = getDays(month);
  const labs = await fetchAllLabours();
  const attMap = {};
  await Promise.all(labs.map(async l => {
    const key = `${l.id}_${month}`;
    const d = await db.collection('attendance').doc(key).get();
    attMap[l.id] = d.exists ? d.data() : {shifts:{}, rate: l.rate};
  }));
  let html = '<table id="ownerTable"><thead><tr><th class="sticky-id">S.No</th><th class="sticky-name">User ID - Name</th>';
  days.forEach(d=> html += `<th>${d}</th>`);
  html += '<th>Total</th><th>Actions</th></tr></thead><tbody>';
  labs.forEach((l,i)=>{
    const rec = attMap[l.id] || {shifts:{}, rate:l.rate};
    let total = 0;
    html += `<tr data-id="${l.id}"><td class="sticky-id">${i+1}</td><td class="sticky-name">${l.id} - ${l.name}</td>`;
    days.forEach((d,ci)=>{ const v = rec.shifts && (rec.shifts[d] !== undefined) ? rec.shifts[d] : 0; total += Number(v)||0;
      // add data-row & data-col for navigation
      html += `<td><input type="number" min="0" step="0.25" inputmode="decimal" class="attCell" data-day="${d}" data-id="${l.id}" data-row="${i}" data-col="${ci}" value="${v}" style="width:68px" onfocus="placeCursorToEnd(this)"></td>`;});
    html += `<td class="rowTotal">${total}</td><td><button onclick="prefillAdv('${l.id}')">Add Advance</button> <button onclick="viewAdvances('${l.id}','${month}')">View</button></td></tr>`;
  });
  html += '</tbody></table>';
  $('ownerTableWrap').innerHTML = html;

  // wire inputs
  document.querySelectorAll('.attCell').forEach(i => {
    i.addEventListener('input', ()=>{ updateRowTotals(); ownerFilter(); });
    i.addEventListener('keydown', attCellArrowNav);
    // prevent auto-select on focus (user requested)
    i.addEventListener('focus', ()=> placeCursorToEnd(i));
  });
  updateRowTotals();
}

/* place cursor at end, avoid auto select */
function placeCursorToEnd(el){
  try{
    const len = (el.value || '').length;
    el.setSelectionRange(len, len);
  }catch(e){}
}

function updateRowTotals(){
  document.querySelectorAll('#ownerTable tbody tr').forEach(tr=>{
    let s = 0; tr.querySelectorAll('.attCell').forEach(ci=> s += Number(ci.value) || 0);
    const cell = tr.querySelector('.rowTotal'); if(cell) cell.textContent = s;
  });
}

/* Arrow navigation for attCell inputs:
   ArrowLeft  -> previous column (same row)
   ArrowRight -> next column
   ArrowUp    -> same column previous row
   ArrowDown  -> same column next row
*/
function attCellArrowNav(e){
  const el = e.target;
  const row = Number(el.dataset.row);
  const col = Number(el.dataset.col);
  if(isNaN(row) || isNaN(col)) return;
  let findSelector;
  if(e.key === 'ArrowLeft'){
    findSelector = `input.attCell[data-row="${row}"][data-col="${col-1}"]`;
  } else if(e.key === 'ArrowRight'){
    findSelector = `input.attCell[data-row="${row}"][data-col="${col+1}"]`;
  } else if(e.key === 'ArrowUp'){
    findSelector = `input.attCell[data-row="${row-1}"][data-col="${col}"]`;
  } else if(e.key === 'ArrowDown'){
    findSelector = `input.attCell[data-row="${row+1}"][data-col="${col}"]`;
  } else {
    return;
  }
  const next = document.querySelector(findSelector);
  if(next){
    e.preventDefault();
    next.focus();
  }
}

/* Save attendance to Firestore */
$('saveAll').onclick = async ()=>{
  if(!isOwnerSignedIn()){ alert('Owner sign-in required to save.'); return; }
  const month = $('ownerMonth').value; if(!month){ alert('Select month'); return; }
  const toSave = {};
  document.querySelectorAll('#ownerTable tbody tr').forEach(tr=>{
    const id = tr.dataset.id;
    const key = `${id}_${month}`;
    const shifts = {};
    tr.querySelectorAll('.attCell').forEach(ci => { const d = ci.dataset.day; shifts[d] = Number(ci.value) || 0; });
    const rate = Number(getRateForLabour(id)) || null;
    toSave[key] = { shifts, rate };
  });
  try {
    await saveAttendanceForMonth(toSave);
    alert('Attendance saved to Firestore.');
  } catch(err){
    alert('Save failed: ' + err.message);
  }
};

/* Search filter */
function ownerFilter(){
  const q = $('ownerSearch').value.trim().toLowerCase();
  document.querySelectorAll('#ownerTable tbody tr').forEach(tr=>{
    const text = (tr.querySelector('.sticky-name')?.textContent || '').toLowerCase();
    tr.style.display = (!q || text.includes(q)) ? '' : 'none';
  });
}

/* ---------- Advances UI ---------- */
async function populateAdvSelect(){
  const sel = $('advList'); sel.innerHTML = '';
  const labs = await fetchAllLabours();
  // Populate datalist options with "id - name" and unique entries
  const seen = new Set();
  labs.forEach(l => {
    const s = `${l.id} - ${l.name}`;
    if(seen.has(s)) return;
    seen.add(s);
    const opt = document.createElement('option'); opt.value = s; sel.appendChild(opt);
  });
  // Also populate hidden select for other code paths
  const sel2 = $('advLab');
  if(sel2){
    sel2.innerHTML = '';
    labs.forEach(l=>{ const o = document.createElement('option'); o.value = l.id; o.textContent = l.id + ' - ' + l.name; sel2.appendChild(o); });
  }
}

$('showAdv').onclick = renderAdvances;

async function renderAdvances(){
  const month = $('advMonth').value || $('ownerMonth').value;
  const labs = await fetchAllLabours();
  const tbody = document.querySelector('#advTable tbody'); tbody.innerHTML = '';
  for(let i=0;i<labs.length;i++){
    const l = labs[i];
    const items = await fetchAdvancesForLab(l.id);
    // preserve time-ordering: earlier entries first (as stored in array)
    const filtered = items.filter(a => a.date && a.date.startsWith(month));
    const tot = filtered.reduce((s,x)=> s + (Number(x.amount)||0), 0);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${l.id}</td><td class="left">${l.name}</td><td>₹${tot}</td><td><button onclick="prefillAdv('${l.id}')">Add</button> <button onclick="viewAdvances('${l.id}','${month}')">View</button></td>`;
    tbody.appendChild(tr);
  }
  await populateAdvSelect();
}

/* Save advance — advLabInput supports typed "ID - name" or direct id */
$('saveAdv').onclick = async ()=>{
  if(!isOwnerSignedIn()){ alert('Owner sign-in required to save advance.'); return; }
  let labVal = $('advLabInput').value.trim();
  if(!labVal){ // fallback to select if present
    const sel = $('advLab');
    if(sel) labVal = sel.value;
  }
  // If user typed "L001 - Name", extract left part
  const m = labVal.match(/^([A-Za-z0-9_-]+)/);
  const lab = m ? m[1] : labVal;
  const date = $('advDate').value;
  const amt = Number($('advAmt').value) || 0;
  const note = $('advNote').value;
  if(!lab || !date || amt <= 0){ alert('Select labour, date and amount'); return; }
  try{
    await appendAdvanceForLab(lab, {date, amount: amt, note});
    // scroll back to top after save as requested
    $('advDate').value=''; $('advAmt').value=''; $('advNote').value=''; $('advLabInput').value='';
    await renderAdvances(); await renderSalarySheet();
    alert('Advance saved to Firestore');
    scrollToTopSmooth();
  } catch(err){
    alert('Save advance failed: ' + err.message);
  }
};
$('clearAdv').onclick = ()=>{ $('advDate').value=''; $('advAmt').value=''; $('advNote').value=''; $('advLabInput').value=''; };

/* prefill adv by ID -> focus panel and scroll to it */
function prefillAdv(id){
  const labs = (async ()=> await fetchAllLabours())();
  // set advLabInput to "ID - name" if possible
  fetchLabourById(id).then(l=>{
    if(l) $('advLabInput').value = `${l.id} - ${l.name}`;
    $('advDate').value = (new Date()).toISOString().slice(0,10);
    scrollToElemSmooth($('advPanel'));
    // focus amount input for convenience
    setTimeout(()=> $('advAmt').focus(), 500);
  }).catch(()=>{ $('advLabInput').value = id; scrollToElemSmooth($('advPanel')); });
}

/* View advances in new tab (keeps chronological order, as stored) */
async function viewAdvances(id, month){
  const items = await fetchAdvancesForLab(id);
  let list = items;
  if(month) list = list.filter(a=> a.date && a.date.startsWith(month));
  list.sort((a,b)=> (a.date||'') < (b.date||'') ? -1 : (a.date||'') > (b.date||'') ? 1 : 0);
  let html = `<html><head><meta charset="utf-8"><title>Advances ${id}</title><style>table{border-collapse:collapse;width:100%}th,td{border:1px solid #333;padding:6px}th{background:#eee}body{font-family:Arial,Helvetica,sans-serif;color:#222}</style></head><body><h2>Advances — ${id}</h2>`;
  if(list.length === 0) html += '<p>No advances</p>'; else {
    html += '<table><thead><tr><th>Date</th><th>Amount</th><th>Note</th></tr></thead><tbody>';
    list.forEach(a=> html += `<tr><td>${a.date}</td><td style="text-align:right">₹${a.amount}</td><td>${a.note||''}</td></tr>`);
    html += '</tbody></table>';
    const tot = list.reduce((s,x)=> s + (Number(x.amount)||0), 0);
    html += `<p><strong>Total: ₹${tot}</strong></p>`;
  }
  html += '</body></html>';
  const w = window.open('', '_blank'); w.document.write(html); w.document.close();
}

/* ---------- Salary sheet UI ---------- */
$('showSalary').onclick = renderSalarySheet;

async function renderSalarySheet(){
  const month = $('salaryMonth').value || $('ownerMonth').value; if(!month){ alert('Select month'); return; }
  const labs = await fetchAllLabours();
  const tbody = document.querySelector('#salaryTable tbody'); tbody.innerHTML = '';
  for(let i=0;i<labs.length;i++){
    const l = labs[i];
    const att = await fetchAttendance(l.id, month);
    const totalShift = Object.values(att.shifts || {}).reduce((s,v)=> s + (Number(v)||0), 0);
    const advItems = await fetchAdvancesForLab(l.id);
    const advTotal = advItems.filter(a=> a.date && a.date.startsWith(month)).reduce((s,x)=> s + (Number(x.amount)||0), 0);
    const saved = await fetchSalary(l.id, month) || {};
    const amtPerShift = Number(saved.amtPerShift !== undefined ? saved.amtPerShift : (att.rate || l.rate)) || Number(l.rate||0);
    const totalAmt = Number((amtPerShift * totalShift).toFixed(2));
    const mess = Number(saved.mess||0), uf = Number(saved.uf||0), pf = Number(saved.pf||0), debit = Number(saved.debit||0), jvc = Number(saved.jvc||0), other = Number(saved.other||0);
    const deductions = Number((advTotal + mess + uf + pf + debit + jvc + other).toFixed(2));
    const calcPaid = Number((totalAmt - deductions).toFixed(2));
    const paid = saved.paid !== undefined ? Number(saved.paid) : calcPaid;
    const paymentMode = saved.paymentMode || l.paymentMode || 'Cash';
    const remarks = saved.remarks || '';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="sticky-id">${i+1}</td><td class="sticky-name">${l.id} - ${l.name}</td>
      <td><input class="sal-amt" data-id="${l.id}" value="${amtPerShift}" style="width:90px" step="0.01" type="number"></td>
      <td><input class="sal-totalShift readonly" data-id="${l.id}" value="${totalShift}" readonly style="width:90px"></td>
      <td><input class="sal-totalAmt readonly" data-id="${l.id}" value="${totalAmt}" readonly style="width:110px"></td>
      <td><input class="sal-monthlyAdvance readonly" data-id="${l.id}" value="${advTotal}" readonly style="width:110px"></td>
      <td><input class="sal-mess" data-id="${l.id}" value="${mess}" style="width:90px"></td>
      <td><input class="sal-uf" data-id="${l.id}" value="${uf}" style="width:90px"></td>
      <td><input class="sal-pf" data-id="${l.id}" value="${pf}" style="width:90px"></td>
      <td><input class="sal-debit" data-id="${l.id}" value="${debit}" style="width:90px"></td>
      <td><input class="sal-jvc" data-id="${l.id}" value="${jvc}" style="width:90px"></td>
      <td><input class="sal-other" data-id="${l.id}" value="${other}" style="width:90px"></td>
      <td>
        <select class="sal-paymode" data-id="${l.id}" style="width:100px">
          <option value="Cash"${paymentMode === 'Cash' ? ' selected' : ''}>Cash</option>
          <option value="A/c"${paymentMode === 'A/c' ? ' selected' : ''}>A/c</option>
        </select>
      </td>
      <td><input class="sal-paid" data-id="${l.id}" value="${paid}" style="width:110px" step="0.01" type="number"></td>
      <td><input class="sal-remarks" data-id="${l.id}" value="${remarks}" style="width:160px" type="text"></td>`;
    tbody.appendChild(tr);
  }
  document.querySelectorAll('#salaryTable input, #salaryTable select').forEach(inp => inp.addEventListener('input', salaryInputsChanged));
}

/* recalc */
function salaryInputsChanged(e){
  const id = e.target.dataset.id; if(!id) return;
  const row = Array.from(document.querySelectorAll('#salaryTable tbody tr')).find(tr => tr.querySelector('.sal-amt')?.dataset.id === id);
  if(!row) return;
  const amtPerShift = Number(row.querySelector('.sal-amt').value) || 0;
  const totalShift = Number(row.querySelector('.sal-totalShift').value) || 0;
  const totalAmt = Number((amtPerShift * totalShift).toFixed(2));
  row.querySelector('.sal-totalAmt').value = totalAmt;
  const monthlyAdvance = Number(row.querySelector('.sal-monthlyAdvance').value) || 0;
  const mess = Number(row.querySelector('.sal-mess').value) || 0;
  const uf = Number(row.querySelector('.sal-uf').value) || 0;
  const pf = Number(row.querySelector('.sal-pf').value) || 0;
  const debit = Number(row.querySelector('.sal-debit').value) || 0;
  const jvc = Number(row.querySelector('.sal-jvc').value) || 0;
  const other = Number(row.querySelector('.sal-other').value) || 0;
  const deductions = Number((monthlyAdvance + mess + uf + pf + debit + jvc + other).toFixed(2));
  const calcPaid = Number((totalAmt - deductions).toFixed(2));
  const paidInput = row.querySelector('.sal-paid');
  paidInput.value = calcPaid;
}

/* Save salary sheet */
$('saveSalary').onclick = async ()=>{
  if(!isOwnerSignedIn()){ alert('Owner sign-in required to save salary.'); return; }
  const month = $('salaryMonth').value || $('ownerMonth').value; if(!month){ alert('Select month'); return; }
  try{
    const rows = document.querySelectorAll('#salaryTable tbody tr');
    for(const r of rows){
      const id = r.querySelector('.sal-amt').dataset.id;
      const payload = {
        amtPerShift: Number(r.querySelector('.sal-amt').value) || 0,
        totalShift: Number(r.querySelector('.sal-totalShift').value) || 0,
        totalAmt: Number(r.querySelector('.sal-totalAmt').value) || 0,
        monthlyAdvance: Number(r.querySelector('.sal-monthlyAdvance').value) || 0,
        mess: Number(r.querySelector('.sal-mess').value) || 0,
        uf: Number(r.querySelector('.sal-uf').value) || 0,
        pf: Number(r.querySelector('.sal-pf').value) || 0,
        debit: Number(r.querySelector('.sal-debit').value) || 0,
        jvc: Number(r.querySelector('.sal-jvc').value) || 0,
        other: Number(r.querySelector('.sal-other').value) || 0,
        paymentMode: r.querySelector('.sal-paymode').value || '',
        paid: Number(r.querySelector('.sal-paid').value) || 0,
        remarks: r.querySelector('.sal-remarks').value || ''
      };
      await saveSalaryRecord(id, month, payload);
    }
    alert('Salary sheet saved to Firestore for ' + month);
    scrollToTopSmooth();
  } catch(err){
    alert('Save salary failed: ' + err.message);
  }
};

/* ---------- Exports (CSV/XLS) ---------- */
async function collectShiftRows(month){
  const labs = await fetchAllLabours();
  const rows = [];
  for(const [i,l] of labs.entries()){
    const key = `${l.id}_${month}`;
    const doc = await db.collection('attendance').doc(key).get();
    const rec = doc.exists ? doc.data() : {shifts:{}};
    const days = getDays(month);
    const dayVals = [];
    let tot=0;
    for(const d of days){ const v = Number(rec.shifts && (rec.shifts[d] !== undefined) ? rec.shifts[d] : 0) || 0; dayVals.push(v); tot += v; }
    rows.push({sno:i+1, id:l.id, name:l.name, days: dayVals, total: tot});
  }
  return {rows, days: getDays(month)};
}
async function exportShiftCSV(){ const month = $('ownerMonth').value; if(!month){ alert('Select month'); return; } const data=await collectShiftRows(month); const header=['S.No','User ID','Name', ...data.days.map(String), 'Total']; const csv=[header.join(',')].concat(data.rows.map(r=> [r.sno, r.id, `"${r.name.replace(/"/g,'""')}"`, ...r.days, r.total].join(','))).join('\n'); downloadBlob(csv, `shifts_${month}.csv`, 'text/csv'); }
async function exportShiftXLS(){ const month=$('ownerMonth').value; if(!month){alert('Select month');return;} const data=await collectShiftRows(month); let html='<table border="1"><tr>'+['S.No','User ID','Name',...data.days.map(String),'Total'].map(h=>`<th>${h}</th>`).join('')+'</tr>'; data.rows.forEach(r=>{ html+='<tr>'; html+=`<td>${r.sno}</td><td>${r.id}</td><td>${r.name}</td>` + r.days.map(d=>`<td>${d}</td>`).join('') + `<td>${r.total}</td></tr>`;}); html+='</table>'; downloadBlob('\uFEFF'+html, `shifts_${month}.xls`, 'application/vnd.ms-excel'); }

/* Export shifts to PDF using html2canvas + jsPDF and auto-download */
async function exportShiftPDF(){ 
  const month=$('ownerMonth').value; if(!month){alert('Select month');return;}
  const data=await collectShiftRows(month);
  // build temporary HTML element
  const wrap = document.createElement('div');
  wrap.style.padding = '12px';
  wrap.style.background = '#fff';
  wrap.innerHTML = `<h2>Shift sheet — ${month}</h2>`;
  let table = `<table style="border-collapse:collapse;width:100%;font-family:Arial,Helvetica,sans-serif"><thead><tr>` + ['S.No','User ID','Name',...data.days.map(String),'Total'].map(h=>`<th style="border:1px solid #333;padding:6px;background:#eee">${h}</th>`).join('') + `</tr></thead><tbody>`;
  data.rows.forEach(r=>{
    table += `<tr><td style="border:1px solid #333;padding:6px">${r.sno}</td><td style="border:1px solid #333;padding:6px">${r.id}</td><td style="border:1px solid #333;padding:6px;text-align:left;padding-left:6px">${r.name}</td>` + r.days.map(d=>`<td style="border:1px solid #333;padding:6px">${d}</td>`).join('') + `<td style="border:1px solid #333;padding:6px">${r.total}</td></tr>`;
  });
  table += '</tbody></table>';
  wrap.innerHTML += table;
  document.body.appendChild(wrap);
  try {
    const canvas = await html2canvas(wrap, {scale:1.5});
    const imgData = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('l','pt','a4');
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = pdf.internal.pageSize.getHeight();
    const imgProps = { width: canvas.width, height: canvas.height };
    const ratio = Math.min(pdfWidth / imgProps.width, pdfHeight / imgProps.height);
    pdf.addImage(imgData, 'PNG', 0, 0, imgProps.width * ratio, imgProps.height * ratio);
    pdf.save(`shifts_${month}.pdf`);
  } catch(err){
    alert('PDF export failed: ' + err.message);
  } finally {
    wrap.remove();
  }
}

/* Salary exports (CSV/XLS and PDF with A/c first then Cash) */
async function collectSalaryRows(month){
  const labs = await fetchAllLabours(); const rows = [];
  for(const [i,l] of labs.entries()){
    const att = await fetchAttendance(l.id, month);
    const totalShift = Object.values(att.shifts||{}).reduce((s,v)=> s + (Number(v)||0), 0);
    const saved = await fetchSalary(l.id, month) || {};
    const amtPerShift = Number(saved.amtPerShift !== undefined ? saved.amtPerShift : (att.rate || l.rate)) || Number(l.rate||0);
    const totalAmt = Number((amtPerShift * totalShift).toFixed(2));
    const advItems = await fetchAdvancesForLab(l.id);
    const advTotal = advItems.filter(a=> a.date && a.date.startsWith(month)).reduce((s,x)=> s + (Number(x.amount)||0), 0);
    const mess = Number(saved.mess||0), uf = Number(saved.uf||0), pf = Number(saved.pf||0), debit = Number(saved.debit||0), jvc = Number(saved.jvc||0), other = Number(saved.other||0);
    const paid = Number(saved.paid !== undefined ? saved.paid : (totalAmt - (advTotal + mess + uf + pf + debit + jvc + other))).toFixed(2);
    const paymentMode = (saved.paymentMode || l.paymentMode || '').toString();
    rows.push({sno:i+1, id:l.id, name:l.name, amtPerShift, totalShift, totalAmt, monthlyAdvance: advTotal, mess, uf, pf, debit, jvc, other, paymentMode, paid, remarks: saved.remarks || ''});
  }
  return rows;
}

async function exportSalaryCSV(){ const month=$('salaryMonth').value || $('ownerMonth').value; if(!month){alert('Select month');return;} const rows=await collectSalaryRows(month); const header=['S.No','User ID','Name','Amt/Shift','Total Shift','Total Amt','Monthly Advance','Mess','U/F','P/F','Debit','JVC','Other','Payment Mode','Paid Salary','Remarks']; const csv=[header.join(',')].concat(rows.map(r=> [r.sno, r.id, `"${r.name.replace(/"/g,'""')}"`, r.amtPerShift, r.totalShift, r.totalAmt, r.monthlyAdvance, r.mess, r.uf, r.pf, r.debit, r.jvc, r.other, `"${r.paymentMode}"`, r.paid, `"${(r.remarks||'').replace(/"/g,'""')}"`].join(','))).join('\n'); downloadBlob(csv, `salary_${month}.csv`, 'text/csv'); }
async function exportSalaryXLS(){ const month=$('salaryMonth').value || $('ownerMonth').value; if(!month){alert('Select month');return;} const rows=await collectSalaryRows(month); let html='<table border="1"><tr>'+['S.No','User ID','Name','Amt/Shift','Total Shift','Total Amt','Monthly Advance','Mess','U/F','P/F','Debit','JVC','Other','Payment Mode','Paid Salary','Remarks'].map(h=>`<th>${h}</th>`).join('')+'</tr>'; rows.forEach(r=> html+=`<tr><td>${r.sno}</td><td>${r.id}</td><td>${r.name}</td><td>${r.amtPerShift}</td><td>${r.totalShift}</td><td>${r.totalAmt}</td><td>${r.monthlyAdvance}</td><td>${r.mess}</td><td>${r.uf}</td><td>${r.pf}</td><td>${r.debit}</td><td>${r.jvc}</td><td>${r.other}</td><td>${r.paymentMode}</td><td>${r.paid}</td><td>${r.remarks||''}</td></tr>`); html += '</table>'; downloadBlob('\uFEFF'+html, `salary_${month}.xls`, 'application/vnd.ms-excel'); }

/* PDF: generate two tables A/c first then Cash, use html2canvas/jsPDF and auto-download */
async function exportSalaryPDF(){
  const month=$('salaryMonth').value || $('ownerMonth').value; if(!month){alert('Select month');return;}
  const rows=await collectSalaryRows(month);
  const acRows = rows.filter(r => (r.paymentMode||'').toLowerCase() === 'a/c');
  const cashRows = rows.filter(r => (r.paymentMode||'').toLowerCase() !== 'a/c');

  // Build temp wrapper
  const wrap = document.createElement('div'); wrap.style.padding='12px'; wrap.style.background='#fff'; wrap.style.fontFamily='Arial,Helvetica,sans-serif';
  wrap.innerHTML = `<h2>Salary sheet — ${month}</h2><p style="color:#666">Generated by Salary Portal</p>`;

  function tableHtml(rowsArray, title){
    if(rowsArray.length === 0) return `<h4>${title}: (none)</h4>`;
    let html = `<h4 style="margin-bottom:6px">${title}</h4><table style="border-collapse:collapse;width:100%"><thead><tr>`;
    ['S.No','User ID','Name','Amt/Shift','Total Shift','Total Amt','Monthly Advance','Mess','U/F','P/F','Debit','JVC','Other','Payment Mode','Paid Salary','Remarks'].forEach(h=> html += `<th style="border:1px solid #333;padding:6px;background:#eee">${h}</th>`);
    html += `</tr></thead><tbody>`;
    rowsArray.forEach(r => {
      html += `<tr><td style="border:1px solid #333;padding:6px">${r.sno}</td><td style="border:1px solid #333;padding:6px">${r.id}</td><td style="border:1px solid #333;padding:6px;text-align:left;padding-left:6px">${r.name}</td><td style="border:1px solid #333;padding:6px">${r.amtPerShift}</td><td style="border:1px solid #333;padding:6px">${r.totalShift}</td><td style="border:1px solid #333;padding:6px">${r.totalAmt}</td><td style="border:1px solid #333;padding:6px">${r.monthlyAdvance}</td><td style="border:1px solid #333;padding:6px">${r.mess}</td><td style="border:1px solid #333;padding:6px">${r.uf}</td><td style="border:1px solid #333;padding:6px">${r.pf}</td><td style="border:1px solid #333;padding:6px">${r.debit}</td><td style="border:1px solid #333;padding:6px">${r.jvc}</td><td style="border:1px solid #333;padding:6px">${r.other}</td><td style="border:1px solid #333;padding:6px">${r.paymentMode}</td><td style="border:1px solid #333;padding:6px">${r.paid}</td><td style="border:1px solid #333;padding:6px">${r.remarks||''}</td></tr>`;
    });
    html += `</tbody></table>`;
    return html;
  }

  wrap.innerHTML += tableHtml(acRows, 'Payment Mode: A/c (A/c first)');
  wrap.innerHTML += `<div style="height:12px"></div>`;
  wrap.innerHTML += tableHtml(cashRows, 'Payment Mode: Cash');

  document.body.appendChild(wrap);
  try {
    const canvas = await html2canvas(wrap, {scale:1.5});
    const imgData = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p','pt','a4');
    const pdfW = pdf.internal.pageSize.getWidth();
    const pdfH = pdf.internal.pageSize.getHeight();
    const imgW = canvas.width;
    const imgH = canvas.height;
    const ratio = Math.min(pdfW / imgW, pdfH / imgH);
    pdf.addImage(imgData, 'PNG', 0, 0, imgW * ratio, imgH * ratio);
    pdf.save(`salary_${month}.pdf`);
  } catch(err){
    alert('PDF export failed: ' + err.message);
  } finally {
    wrap.remove();
  }
}

/* ---------- Advances export ---------- */
async function collectAdvForMonth(month){
  const labs = await fetchAllLabours();
  const rows = [];
  for(const [i,l] of labs.entries()){
    const items = await fetchAdvancesForLab(l.id);
    const filtered = items.filter(a => a.date && a.date.startsWith(month));
    // preserve stored order (time order)
    for(const f of filtered){
      rows.push({sno: rows.length+1, id: l.id, name: l.name, date: f.date, amount: Number(f.amount)||0, note: f.note||''});
    }
  }
  return rows;
}
async function exportAdvCSV(){ const month = $('advMonth').value || $('ownerMonth').value; if(!month){ alert('Select month'); return; } const rows = await collectAdvForMonth(month); const header = ['S.No','User ID','Name','Date','Amount','Note']; const csv = [header.join(',')].concat(rows.map(r => [r.sno, r.id, `"${r.name.replace(/"/g,'""')}"`, r.date, r.amount, `"${(r.note||'').replace(/"/g,'""')}"`].join(','))).join('\n'); downloadBlob(csv, `advances_${month}.csv`, 'text/csv'); }
async function exportAdvXLS(){ const month = $('advMonth').value || $('ownerMonth').value; if(!month){ alert('Select month'); return; } const rows = await collectAdvForMonth(month); let html = '<table border="1"><tr>' + ['S.No','User ID','Name','Date','Amount','Note'].map(h=>`<th>${h}</th>`).join('') + '</tr>'; rows.forEach(r => { html += `<tr><td>${r.sno}</td><td>${r.id}</td><td>${r.name}</td><td>${r.date}</td><td>${r.amount}</td><td>${r.note}</td></tr>`; }); html += '</table>'; downloadBlob('\uFEFF'+html, `advances_${month}.xls`, 'application/vnd.ms-excel'); }
async function exportAdvPDF(){ const month = $('advMonth').value || $('ownerMonth').value; if(!month){ alert('Select month'); return; } const rows = await collectAdvForMonth(month); const wrap = document.createElement('div'); wrap.style.padding='12px'; wrap.style.background='#fff'; wrap.innerHTML = `<h2>Advances — ${month}</h2>`; if(rows.length===0){ wrap.innerHTML += '<p>No advances for selected month.</p>'; document.body.appendChild(wrap); setTimeout(()=>{ window.print(); wrap.remove(); }, 500); return; } let html = '<table style="border-collapse:collapse;width:100%"><thead><tr>' + ['S.No','User ID','Name','Date','Amount','Note'].map(h=>`<th style="border:1px solid #333;padding:6px;background:#eee">${h}</th>`).join('') + '</tr></thead><tbody>'; rows.forEach(r=> html += `<tr><td style="border:1px solid #333;padding:6px">${r.sno}</td><td style="border:1px solid #333;padding:6px">${r.id}</td><td style="border:1px solid #333;padding:6px;text-align:left;padding-left:6px">${r.name}</td><td style="border:1px solid #333;padding:6px">${r.date}</td><td style="border:1px solid #333;padding:6px;text-align:right">${r.amount}</td><td style="border:1px solid #333;padding:6px">${r.note}</td></tr>`); html += '</tbody></table>'; wrap.innerHTML += html; document.body.appendChild(wrap); try{ const canvas = await html2canvas(wrap, {scale:1.5}); const imgData = canvas.toDataURL('image/png'); const { jsPDF } = window.jspdf; const pdf = new jsPDF('p','pt','a4'); const pdfW = pdf.internal.pageSize.getWidth(); const pdfH = pdf.internal.pageSize.getHeight(); const ratio = Math.min(pdfW / canvas.width, pdfH / canvas.height); pdf.addImage(imgData, 'PNG', 0, 0, canvas.width*ratio, canvas.height*ratio); pdf.save(`advances_${month}.pdf`); }catch(e){ alert('PDF export failed: ' + e.message); } finally{ wrap.remove(); } }

/* download blob helper (for CSV/XLS) */
function downloadBlob(content, filename, mime){
  const blob = new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download=filename;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

/* ---------- Labour management UI ---------- */
async function renderLabourList(){
  const labs = await fetchAllLabours();
  let html='<table><thead><tr><th>S.No</th><th>User ID</th><th>Name</th><th>Rate/shift</th><th>Payment Mode</th><th>Actions</th></tr></thead><tbody>';
  labs.forEach((l,i)=> html += `<tr><td>${i+1}</td><td>${l.id}</td><td class="left">${l.name}</td><td>₹${l.rate}</td><td>${l.paymentMode || 'Cash'}</td><td><button onclick="openEditLabour('${l.id}')">Edit</button> <button onclick="deleteLabour('${l.id}')">Delete</button></td></tr>`);
  html += '</tbody></table>';
  $('labourList').innerHTML = html;
}
$('addLabour').onclick = ()=> openLabourModal();

/* open modal and scroll to it; after save scroll up */
function openLabourModal(editId){
  $('labourModal').classList.remove('hidden');
  if(editId){
    fetchLabourById(editId).then(lab=>{
      $('labourModalTitle').textContent = 'Edit Labour';
      $('modalUserId').value = lab.id; $('modalName').value = lab.name; $('modalPwd').value = lab.password; $('modalRate').value = lab.rate;
      $('modalPayMode').value = lab.paymentMode || 'Cash';
      $('labourModal').dataset.edit = editId;
      scrollToElemSmooth($('labourModal'));
    }).catch(()=>{ alert('Failed to fetch labour'); });
  } else {
    $('labourModalTitle').textContent = 'Add Labour';
    $('modalUserId').value=''; $('modalName').value=''; $('modalPwd').value='1234'; $('modalRate').value='500';
    $('modalPayMode').value = 'Cash';
    delete $('labourModal').dataset.edit;
    scrollToElemSmooth($('labourModal'));
  }
}
function openEditLabour(id){ openLabourModal(id); }
$('cancelLabourBtn').onclick = ()=> { $('labourModal').classList.add('hidden'); scrollToTopSmooth(); }

$('saveLabourBtn').onclick = async ()=>{
  if(!isOwnerSignedIn()){ alert('Owner sign-in required'); return; }
  const id=$('modalUserId').value.trim(), name=$('modalName').value.trim(), pwd=$('modalPwd').value.trim(), rate=Number($('modalRate').value)||0;
  const paymentMode = $('modalPayMode').value || 'Cash';
  if(!id||!name){ alert('Enter ID and name'); return; }
  try{
    await saveLabourToFirestore({id, name, password: pwd, rate, paymentMode});
    $('labourModal').classList.add('hidden');
    await renderLabourList(); await generateOwnerTable(); await populateAdvSelect(); await renderSalarySheet();
    alert('Saved');
    scrollToTopSmooth();
  } catch(err){ alert('Save failed: ' + err.message); }
};

async function deleteLabour(id){
  if(!isOwnerSignedIn()){ alert('Owner sign-in required to delete labour.'); return; }
  if(!confirm('Delete labour and all data?')) return;
  try{
    await deleteLabourFromFirestore(id);
    await renderLabourList(); await generateOwnerTable(); await renderSalarySheet(); await renderAdvances();
    alert('Deleted ' + id);
  } catch(err){ alert('Delete failed: ' + err.message); }
}

/* ---------- Labour UI (view only) ---------- */
function renderLabourInfo(){ if(!currentLabour) return; $('labourInfo').innerHTML = `<p><strong>${currentLabour.name}</strong> (ID: ${currentLabour.id})</p>`; }
async function renderLabourView(){
  if(!currentLabour) return; const month = $('labourMonth').value; if(!month) return;
  const rec = await fetchAttendance(currentLabour.id, month);
  const days = getDays(month);
  let html = '<h3>Attendance</h3><table><thead><tr><th>Date</th><th>Shifts</th></tr></thead><tbody>';
  let total = 0;
  days.forEach(d=>{ const v = Number(rec.shifts && rec.shifts[d] !== undefined ? rec.shifts[d] : 0) || 0; html += `<tr><td class="left">${d}</td><td>${v}</td></tr>`; total += v; });
  html += `</tbody></table><p class="small">Total shifts: ${total}</p>`;
  $('labourAttendance').innerHTML = html;

  const advItemsAll = await fetchAdvancesForLab(currentLabour.id);
  const advList = advItemsAll.filter(a=> a.date && a.date.startsWith(month)).sort((a,b)=> a.date < b.date ? -1 : (a.date > b.date ? 1 : 0));
  let advHtml = '<h3>Advances</h3>';
  if(!advList.length) advHtml += '<p class="small">No advances for month</p>'; else { advHtml += '<table><thead><tr><th>Date</th><th>Amount</th><th>Note</th></tr></thead><tbody>'; advList.slice().reverse().forEach(a=> advHtml += `<tr><td>${a.date}</td><td style="text-align:right">₹${a.amount}</td><td class="left">${a.note||''}</td></tr>`); advHtml += '</tbody></table>'; advHtml += `<p class="small"><strong>Total: ₹${advList.reduce((s,x)=> s + (Number(x.amount)||0),0)}</strong></p>`; }
  $('labourAdvance').innerHTML = advHtml;

  const saved = await fetchSalary(currentLabour.id, month) || {};
  const amtPerShift = Number(saved.amtPerShift !== undefined ? saved.amtPerShift : (rec.rate||currentLabour.rate)) || currentLabour.rate;
  const totalShift = Object.values(rec.shifts||{}).reduce((s,v)=> s + (Number(v)||0), 0);
  const totalAmt = Number((amtPerShift * totalShift).toFixed(2));
  const advTotal = advList.reduce((s,x)=> s + (Number(x.amount)||0), 0);
  const mess = Number(saved.mess||0), uf = Number(saved.uf||0), pf = Number(saved.pf||0), debit = Number(saved.debit||0), jvc = Number(saved.jvc||0), other = Number(saved.other||0);
  const deductions = Number((advTotal + mess + uf + pf + debit + jvc + other).toFixed(2));
  const paidCalculated = Number((totalAmt - deductions).toFixed(2));
  let salaryHtml = `<h3>Salary — ${month}</h3>`;
  salaryHtml += `<table><tbody>`;
  salaryHtml += `<tr><td class="left">Amt/Shift</td><td>₹${amtPerShift}</td></tr>`;
  salaryHtml += `<tr><td class="left">Total Shift</td><td>${totalShift}</td></tr>`;
  salaryHtml += `<tr><td class="left">Total Amount</td><td>₹${totalAmt}</td></tr>`;
  salaryHtml += `<tr><td class="left">Monthly Advance (sum of advances)</td><td>₹${advTotal}</td></tr>`;
  salaryHtml += `<tr><td class="left">Mess</td><td>₹${mess}</td></tr>`;
  salaryHtml += `<tr><td class="left">U/F</td><td>₹${uf}</td></tr>`;
  salaryHtml += `<tr><td class="left">P/F</td><td>₹${pf}</td></tr>`;
  salaryHtml += `<tr><td class="left">Debit</td><td>₹${debit}</td></tr>`;
  salaryHtml += `<tr><td class="left">JVC</td><td>₹${jvc}</td></tr>`;
  salaryHtml += `<tr><td class="left">Other</td><td>₹${other}</td></tr>`;
  salaryHtml += `<tr><td class="left"><strong>Paid (calculated)</strong></td><td><strong>₹${paidCalculated}</strong></td></tr>`;
  salaryHtml += `<tr><td class="left">Paid (owner saved)</td><td>${saved.paid !== undefined ? '₹'+saved.paid : '—'}</td></tr>`;
  salaryHtml += `</tbody></table>`;
  $('labourSalary').innerHTML = salaryHtml;
}

/* ---------- Auth guard ---------- */
function isOwnerSignedIn(){
  const user = auth.currentUser;
  return user && user.uid === OWNER_UID;
}
auth.onAuthStateChanged(user => {
  if(user) $('ownerAuthMsg').textContent = 'Signed in as UID: ' + user.uid;
  else $('ownerAuthMsg').textContent = '';
});

/* ---------- getRateForLabour helper (synchronous fallback) ---------- */
let _cachedLabours = null;
async function _ensureLabCache(){ if(!_cachedLabours) _cachedLabours = await fetchAllLabours(); }
function getRateForLabour(id){
  // note: this is synchronous; returns 0 if unknown. Used only for saving attendance initial payloads.
  try{
    if(_cachedLabours) {
      const item = _cachedLabours.find(x=> x.id === id);
      return item ? Number(item.rate) || 0 : 0;
    }
    return 0;
  }catch(e){ return 0; }
}

/* ---------- on load ---------- */
window.addEventListener('load', async ()=>{
  try{
    _cachedLabours = await fetchAllLabours();
    await populateAdvSelect();
    await renderLabourList();
  }catch(e){ console.warn('Init load: ', e && e.message); }
});

/* ---------- wire export buttons ---------- */
$('exportShiftCSV').onclick = exportShiftCSV;
$('exportShiftXLS').onclick = exportShiftXLS;
$('exportShiftPDF').onclick = exportShiftPDF;
$('exportSalaryCSV').onclick = exportSalaryCSV;
$('exportSalaryXLS').onclick = exportSalaryXLS;
$('exportSalaryPDF').onclick = exportSalaryPDF;
$('exportAdvCSV').onclick = exportAdvCSV;
$('exportAdvXLS').onclick = exportAdvXLS;
$('exportAdvPDF').onclick = exportAdvPDF;

/* ---------- Utility: one-time migration helper (optional, not automatically run) ----------
   If you want to add createdAt to existing records from console:
   Paste and run the following (owner must be signed in):

(async ()=>{
  const snap = await db.collection('labours').get();
  const batch = db.batch();
  let count = 0;
  snap.docs.forEach(doc => {
    if(!doc.data().createdAt){
      batch.set(doc.ref, { createdAt: firebase.firestore.Timestamp.fromDate(new Date()) }, { merge:true });
      count++;
    }
  });
  if(count === 0){ alert('No docs needed update'); return; }
  await batch.commit();
  alert('Added createdAt to ' + count + ' docs');
})();
*/

/* End script */
</script>
</body>
</html>
