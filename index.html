<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Labour Shift, Advance & Salary Portal (Firestore)</title>
<style>
  :root{--sticky-id:100px;--sticky-name:260px}
  body{font-family:Arial,Helvetica,sans-serif;background:#f5f7fb;margin:0;color:#222}
  .wrap{max-width:1200px;margin:18px auto;padding:14px}
  .card{background:#fff;border-radius:10px;padding:14px;margin-bottom:12px;box-shadow:0 6px 20px rgba(20,20,40,0.05)}
  h1{margin:6px 0 12px;font-size:20px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  input,select,button,textarea{font-size:14px;padding:8px;border-radius:8px;border:1px solid #d6e0ef}
  button{cursor:pointer}
  .btn{background:#0b79ff;color:#fff;border:none}
  .btn-muted{background:#6c757d;color:#fff;border:none}
  .success{background:#28a745;color:#fff;border:none}
  .danger{background:#dc3545;color:#fff;border:none}
  table{border-collapse:collapse;width:100%;font-size:13px}
  th,td{border:1px solid #e8eef8;padding:6px;text-align:center;white-space:nowrap}
  th{background:#f3f8ff}
  .small{font-size:12px;color:#555}
  .muted{color:#666}
  .hidden{display:none}
  .table-wrap{overflow:auto;background:#fff;padding:8px;border-radius:8px}
  table thead th.sticky-id, table tbody td.sticky-id{ position:sticky; left:0; background:#fff; z-index:4; min-width:var(--sticky-id) }
  table thead th.sticky-name, table tbody td.sticky-name{ position:sticky; left:var(--sticky-id); background:#fff; z-index:3; min-width:var(--sticky-name); text-align:left; padding-left:10px }
  .readonly{background:#f6f8fb}
  .left { text-align:left; padding-left:6px }
  @media (max-width:1100px){ :root{--sticky-name:160px} }
  .controls{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .search{width:260px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card" id="homeCard">
    <h1>Labour Shift, Advance & Salary Portal (Firestore)</h1>
    <div class="row">
      <button class="btn" id="ownerBtn">Owner Login</button>
      <button class="btn-muted" id="labourBtn">Labour Login</button>
      <div style="flex:1"></div>
    </div>
    <p class="small muted">Owner must sign in to perform saves (Firestore writes).</p>
  </div>

  <!-- Owner Login (email/password using Firebase Auth) -->
  <div class="card hidden" id="ownerLoginCard">
    <h3>Owner Login (Firebase)</h3>
    <label>Email</label><br>
    <input id="ownerEmail" type="email" placeholder="owner@example.com" autocomplete="off"><br>
    <label>Password</label><br>
    <input id="ownerPassword" type="password" placeholder="password" autocomplete="off">
    <div style="margin-top:10px">
      <button class="btn" id="ownerLogin">Sign In</button>
      <button id="ownerBack">Back</button>
    </div>
    <div id="ownerAuthMsg" class="small muted" style="margin-top:8px"></div>
  </div>

  <!-- Labour Login (ID only) -->
  <div class="card hidden" id="labourLoginCard">
    <h3>Labour Login (ID only)</h3>
    <label>User ID</label><br>
    <input id="labUserId" placeholder="L001" autocomplete="off">
    <div style="margin-top:10px">
      <button class="btn" id="labourLoginBtn">Login</button>
      <button id="labourBack">Back</button>
    </div>
    <p class="small muted">Labour login requires only User ID — no password shown to labour.</p>
  </div>

  <!-- Owner Dashboard -->
  <div class="card hidden" id="ownerDashboard">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h2>Owner Dashboard</h2>
      <div><button id="ownerLogout">Sign Out</button></div>
    </div>

    <div class="controls">
      <label>Month</label>
      <input type="month" id="ownerMonth">
      <button class="btn" id="loadTable">Load Table</button>
      <button id="addLabour">Add Labour</button>
      <button id="exportBackup">Export Backup (local snapshot)</button>
      <div style="flex:1"></div>
      <label>Search</label>
      <input id="ownerSearch" class="search" placeholder="ID or name" oninput="ownerFilter()">
      <button class="success" id="saveAll">Save All (to Firestore)</button>
      <button id="exportShiftCSV">Export Shifts CSV</button>
      <button id="exportShiftXLS">Export Shifts XLS</button>
      <button id="exportShiftPDF">Export Shifts PDF</button>
    </div>

    <div id="ownerTableWrap" class="table-wrap card"></div>

    <div class="card" id="advancesCard" style="margin-top:12px">
      <h3>Advances</h3>
      <div style="display:flex;align-items:center;gap:8px">
        <label>Month</label><input type="month" id="advMonth">
        <button id="showAdv">Show</button>
        <div style="flex:1"></div>
        <!-- new advance export buttons -->
        <button id="exportAdvCSV">Export Adv CSV</button>
        <button id="exportAdvXLS">Export Adv XLS</button>
        <button id="exportAdvPDF">Export Adv PDF</button>
      </div>
      <div style="display:flex;gap:12px;margin-top:12px">
        <div style="flex:1">
          <table id="advTable"><thead><tr><th>S.No</th><th>ID</th><th>Name</th><th>Total (₹)</th><th>Actions</th></tr></thead><tbody></tbody></table>
        </div>
        <div style="width:360px">
          <h4 id="addAdvTitle">Add Advance</h4>
          <label>Labour (search)</label>
          <!-- Searchable labour input using datalist -->
          <input id="advLab" list="advLabList" placeholder="Type ID or name..." style="width:100%">
          <datalist id="advLabList"></datalist>

          <label>Date</label><input id="advDate" type="date">
          <label>Amount (₹)</label><input id="advAmt" type="number" min="0" step="any" inputmode="decimal">
          <label>Note</label><textarea id="advNote" rows="3" style="width:100%"></textarea>
          <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
            <button class="btn" id="saveAdv">Save Advance</button>
            <button id="clearAdv">Clear</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card" id="salaryCard" style="margin-top:12px">
      <h3>Salary Sheet</h3>
      <div style="display:flex;gap:8px;align-items:center">
        <label>Month</label>
        <input type="month" id="salaryMonth">
        <button id="showSalary">Show Salary</button>
        <div style="flex:1"></div>
        <button class="success" id="saveSalary">Save Salary Sheet</button>
        <button id="exportSalaryCSV">Download Salary CSV</button>
        <button id="exportSalaryXLS">Download Salary XLS</button>
        <button id="exportSalaryPDF">Download Salary PDF</button>
      </div>
      <div class="table-wrap" style="margin-top:10px">
        <table id="salaryTable"><thead><tr>
          <th class="sticky-id">S.No</th><th class="sticky-name">User ID - Name</th>
          <th>Amt/Shift</th><th>Total Shift</th><th>Total Amt</th>
          <th>Monthly Advance</th><th>Mess</th><th>U/F</th><th>P/F</th><th>Debit</th><th>JVC</th><th>Other</th><th>Payment Mode</th><th>Paid Salary</th><th>Remarks / Signature</th>
        </tr></thead><tbody></tbody></table>
      </div>
      <p class="small muted">Paid = TotalAmt − (MonthlyAdvance + Mess + U/F + P/F + Debit + JVC + Other). Owner may override Paid before saving.</p>
    </div>

    <hr>
    <h3 class="small">Manage Labours</h3>
    <div id="labourList"></div>
  </div>

  <!-- Labour Dashboard -->
  <div class="card hidden" id="labourDashboard">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h2>Labour Portal</h2>
      <div><button id="labourLogout">Back</button></div>
    </div>
    <div id="labourInfo"></div>
    <label>Select Month</label>
    <input type="month" id="labourMonth" onchange="renderLabourView()">
    <div id="labourAttendance" class="card" style="margin-top:8px"></div>
    <div id="labourAdvance" class="card" style="margin-top:8px"></div>
    <div id="labourSalary" class="card" style="margin-top:8px"></div>
  </div>

  <!-- Modal: Add/Edit Labour -->
  <div class="card hidden" id="labourModal">
    <h3 id="labourModalTitle">Add Labour</h3>
    <label>User ID</label><input id="modalUserId"><br>
    <label>Name</label><input id="modalName"><br>
    <label>Password</label><input id="modalPwd"><br>
    <label>Rate per shift (₹)</label><input id="modalRate" type="number" min="0" step="any"><br>
    <!-- NEW: Payment mode -->
    <label>Payment Mode</label>
    <select id="modalPayMode" style="width:120px">
      <option value="Cash">Cash</option>
      <option value="A/c">A/c</option>
    </select>
    <div style="margin-top:10px">
      <button class="btn" id="saveLabourBtn">Save</button>
      <button id="cancelLabourBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
/* ---------------------------
  Put your firebase config here (you gave this earlier)
---------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyD4Ax31xHSiW4d4j-YgwcmvH1kPc4OrUoU",
  authDomain: "vfs-labour-portal-8ba3c.firebaseapp.com",
  projectId: "vfs-labour-portal-8ba3c",
  storageBucket: "vfs-labour-portal-8ba3c.firebasestorage.app",
  messagingSenderId: "212643125844",
  appId: "1:212643125844:web:ff2757e75fd37203fc6bc1",
  measurementId: "G-1SF18YYT6P"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* OWNER UID — set to the UID you created in Firebase Auth */
const OWNER_UID = 'D0iiwtC6w9O9qImWLQUXDxKP7lc2'; // <-- replace with your owner UID if different

/* ===== Simple DOM helper ===== */
const $ = id => document.getElementById(id);

/* ===== Navigation UI wiring ===== */
function hideAll(){ ['ownerLoginCard','labourLoginCard','ownerDashboard','labourDashboard','labourModal'].forEach(id=>$(id).classList.add('hidden')); $('homeCard').classList.add('hidden'); }
$('ownerBtn').onclick = ()=>{ hideAll(); $('ownerLoginCard').classList.remove('hidden'); };
$('labourBtn').onclick = ()=>{ hideAll(); $('labourLoginCard').classList.remove('hidden'); };
$('ownerBack').onclick = ()=>location.reload();
$('labourBack').onclick = ()=>location.reload();

/* ===== Auth (owner sign-in) ===== */
$('ownerLogin').onclick = async ()=>{
  const email = $('ownerEmail').value.trim();
  const pwd = $('ownerPassword').value.trim();
  if(!email || !pwd){ alert('Enter email and password'); return; }
  try{
    const userCred = await auth.signInWithEmailAndPassword(email, pwd);
    const uid = userCred.user.uid;
    $('ownerAuthMsg').textContent = 'Signed in UID: ' + uid;
    if(uid !== OWNER_UID) {
      alert('Signed in UID does not match OWNER_UID variable. Update OWNER_UID in code or use the owner with that UID.');
    }
    hideAll(); $('ownerDashboard').classList.remove('hidden'); await initOwnerView();
  } catch(err){
    alert('Sign in failed: ' + err.message);
  }
};
$('ownerLogout').onclick = async ()=>{ await auth.signOut(); location.reload(); };

/* ===== Labour login (ID only) ===== */
let currentLabour = null;
$('labourLoginBtn').onclick = async ()=>{
  const id = $('labUserId').value.trim();
  if(!id){ alert('Enter your User ID'); return; }
  try {
    const labDoc = await db.collection('labours').doc(id).get();
    if(!labDoc.exists){
      alert('User ID not found in Firestore. Create labour as owner first.');
      return;
    }
    currentLabour = labDoc.data();
    currentLabour.id = labDoc.id;
    hideAll(); $('labourDashboard').classList.remove('hidden');
    $('labourMonth').value = (new Date()).toISOString().slice(0,7);
    renderLabourInfo(); renderLabourView();
  } catch(err){
    alert('Error fetching labour: ' + err.message);
  }
};
$('labourLogout').onclick = ()=> location.reload();

/* ========== Firestore helper functions ========== */

/* Labours collection: doc id = labour id
   We'll fetch all docs then sort by createdAt (desc) if available, otherwise keep existing order.
*/
async function fetchAllLabours(){
  const snap = await db.collection('labours').get();
  const arr = snap.docs.map(d => {
    const data = d.data();
    return { id: d.id, __createdAt: data.createdAt || null, ...data };
  });
  // Sort: those with createdAt first (desc), then those without (original order)
  arr.sort((a,b) => {
    if(a.__createdAt && b.__createdAt) return (b.__createdAt.seconds || b.__createdAt._seconds || 0) - (a.__createdAt.seconds || a.__createdAt._seconds || 0);
    if(a.__createdAt) return -1;
    if(b.__createdAt) return 1;
    return 0;
  });
  return arr;
}
async function fetchLabourById(id){
  const d = await db.collection('labours').doc(id).get();
  if(!d.exists) return null;
  return {id: d.id, ...d.data()};
}
async function saveLabourToFirestore(lab){
  // lab: {id,name,password,rate,paymentMode}
  // Preserve createdAt if updating; add createdAt on create
  const ref = db.collection('labours').doc(lab.id);
  const doc = await ref.get();
  if(doc.exists){
    // update, keep createdAt
    await ref.set({
      name: lab.name || '',
      password: lab.password || '',
      rate: Number(lab.rate) || 0,
      paymentMode: lab.paymentMode || 'Cash',
      id: lab.id
    }, {merge:true});
  } else {
    // new labour: add createdAt
    await ref.set({
      name: lab.name || '',
      password: lab.password || '',
      rate: Number(lab.rate) || 0,
      paymentMode: lab.paymentMode || 'Cash',
      id: lab.id,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  }
}
async function deleteLabourFromFirestore(id){
  // Delete doc and associated attendance/advances/salaries docs (best-effort)
  await db.collection('labours').doc(id).delete();
  // attendance docs named id_month
  const attAll = await db.collection('attendance').get();
  const batch = db.batch();
  attAll.docs.forEach(doc => {
    if(doc.id.startsWith(id + '_')) batch.delete(doc.ref);
  });
  const advDoc = db.collection('advances').doc(id);
  batch.delete(advDoc);
  const salAll = await db.collection('salaries').get();
  salAll.docs.forEach(doc => { if(doc.id.startsWith(id + '_')) batch.delete(doc.ref); });
  await batch.commit();
}

/* Attendance docs: id = `${labId}_${month}` with { shifts: { day: num }, rate }
   Example doc id: "L001_2025-12"
*/
async function fetchAttendance(labId, month){
  const id = `${labId}_${month}`;
  const d = await db.collection('attendance').doc(id).get();
  return d.exists ? d.data() : {shifts:{}, rate: null};
}
async function saveAttendanceForMonth(attObjMap){ 
  // attObjMap: { "<labId>_<month>": {shifts:{}, rate: number} , ... }
  const batch = db.batch();
  for(const key of Object.keys(attObjMap)){
    batch.set(db.collection('attendance').doc(key), attObjMap[key], {merge:true});
  }
  await batch.commit();
}

/* Advances docs: id = labour id, structure: { items: [ {date, amount, note} ] } */
async function fetchAdvancesForLab(labId){
  const d = await db.collection('advances').doc(labId).get();
  return d.exists ? (d.data().items || []) : [];
}
async function appendAdvanceForLab(labId, advanceItem){
  // advanceItem: {date, amount, note}
  const ref = db.collection('advances').doc(labId);
  await ref.set({ items: firebase.firestore.FieldValue.arrayUnion(advanceItem) }, {merge:true});
}

/* Salaries docs: id = `${labId}_${month}` with salary fields */
async function fetchSalary(labId, month){
  const id = `${labId}_${month}`;
  const d = await db.collection('salaries').doc(id).get();
  return d.exists ? d.data() : null;
}
async function saveSalaryRecord(labId, month, payload){
  const id = `${labId}_${month}`;
  await db.collection('salaries').doc(id).set(payload, {merge:true});
}

/* Helper: collect all attendance docs for a month (for owner table export) */
async function collectAttendanceForMonth(month){
  const labs = await fetchAllLabours();
  const rows = [];
  for(const [i,l] of labs.entries()){
    const key = `${l.id}_${month}`;
    const doc = await db.collection('attendance').doc(key).get();
    const rec = doc.exists ? doc.data() : {shifts:{}};
    rows.push({ sno: i+1, id: l.id, name: l.name, shifts: rec.shifts || {}, rate: rec.rate || l.rate });
  }
  return { rows, labs };
}

/* ========== UI functions that use Firestore ========== */

/* Init owner view: fetch labours to render */
async function initOwnerView(){
  $('ownerMonth').value = (new Date()).toISOString().slice(0,7);
  $('advMonth').value = $('ownerMonth').value;
  $('salaryMonth').value = $('ownerMonth').value;
  await generateOwnerTable();
  await renderLabourList();
  await populateAdvSelect();
  await renderAdvances();
  await renderSalarySheet();
}

/* Generate owner attendance table (pulls attendance docs from Firestore) */
async function generateOwnerTable(){
  const month = $('ownerMonth').value; if(!month){ alert('Select month'); return; }
  const days = getDays(month);
  const labs = await fetchAllLabours();
  const attMap = {};
  await Promise.all(labs.map(async l => {
    const key = `${l.id}_${month}`;
    const d = await db.collection('attendance').doc(key).get();
    attMap[l.id] = d.exists ? d.data() : {shifts:{}, rate: l.rate};
  }));
  let html = '<table id="ownerTable"><thead><tr><th class="sticky-id">S.No</th><th class="sticky-name">User ID - Name</th>';
  days.forEach(d=> html += `<th>${d}</th>`);
  html += '<th>Total</th><th>Actions</th></tr></thead><tbody>';
  labs.forEach((l,i)=>{
    const rec = attMap[l.id] || {shifts:{}, rate:l.rate};
    let total = 0;
    html += `<tr data-id="${l.id}"><td class="sticky-id">${i+1}</td><td class="sticky-name">${l.id} - ${l.name}</td>`;
    days.forEach(d=>{ 
      const v = rec.shifts && (rec.shifts[d] !== undefined) ? rec.shifts[d] : 0;
      total += Number(v)||0;
      // allow decimals (step="any") and don't auto-select on focus
      html += `<td><input type="number" step="any" inputmode="decimal" min="0" class="attCell" data-day="${d}" data-id="${l.id}" value="${v}" style="width:68px"></td>`;
    });
    html += `<td class="rowTotal">${total}</td><td><button onclick="prefillAdv('${l.id}')">Add Advance</button> <button onclick="viewAdvances('${l.id}','${month}')">View</button></td></tr>`;
  });
  html += '</tbody></table>';
  $('ownerTableWrap').innerHTML = html;
  document.querySelectorAll('.attCell').forEach(i => i.addEventListener('input', ()=>{ updateRowTotals(); ownerFilter(); }));
  // enable arrow navigation for shift cells
  enableArrowNavigation();
  updateRowTotals();
}
$('loadTable').onclick = generateOwnerTable;

function updateRowTotals(){
  document.querySelectorAll('#ownerTable tbody tr').forEach(tr=>{
    let s = 0; tr.querySelectorAll('.attCell').forEach(ci=> s += Number(ci.value) || 0);
    const cell = tr.querySelector('.rowTotal'); if(cell) cell.textContent = s;
  });
}

/* Arrow-key navigation and movement for attendance cells (no auto-select on focus) */
function enableArrowNavigation(){
  // This function wires keyboard nav for attCell inputs inside the owner table.
  const table = document.querySelector('#ownerTable');
  if(!table) return;

  // helper: find input at rowIndex, colIndex (table cell index)
  function getInputAt(rowIndex, cellIndex){
    const tr = table.rows[rowIndex];
    if(!tr) return null;
    const td = tr.cells[cellIndex];
    if(!td) return null;
    return td.querySelector('input');
  }

  // attach to each attCell
  table.querySelectorAll('.attCell').forEach(input => {
    // remove existing handlers to avoid duplication
    input.onkeydown = null;
    input.onkeyup = null;

    input.addEventListener('keydown', function(e){
      const td = input.parentElement;
      const tr = td.parentElement;
      const rowIdx = tr.sectionRowIndex + 1; // sectionRowIndex starts 0 for tbody
      // compute cell index in the whole row (including sticky cols)
      const cellIdx = td.cellIndex;
      // ArrowRight
      if(e.key === 'ArrowRight'){
        e.preventDefault();
        const next = getInputAt(rowIdx, cellIdx + 1);
        if(next) next.focus();
      } else if(e.key === 'ArrowLeft'){
        e.preventDefault();
        const prev = getInputAt(rowIdx, cellIdx - 1);
        if(prev) prev.focus();
      } else if(e.key === 'ArrowDown'){
        e.preventDefault();
        const down = getInputAt(rowIdx + 1, cellIdx);
        if(down) down.focus();
      } else if(e.key === 'ArrowUp'){
        e.preventDefault();
        const up = getInputAt(rowIdx - 1, cellIdx);
        if(up) up.focus();
      } else if(e.key === 'Enter'){
        e.preventDefault();
        const down = getInputAt(rowIdx + 1, cellIdx);
        if(down) down.focus();
      } else if(e.key === 'Tab'){
        // let the browser handle tab across the page, but we override to move to next cell in table
        e.preventDefault();
        if(e.shiftKey){
          const prev = getInputAt(rowIdx, cellIdx - 1);
          if(prev) prev.focus();
        } else {
          const next = getInputAt(rowIdx, cellIdx + 1);
          if(next) next.focus();
        }
      }
    });

    // allow typing decimal point and numbers; do not auto-select
    input.addEventListener('input', function(){
      // simply update row totals when value changes
      updateRowTotals();
    });

    // Optional: numeric-key quick next behavior (if desired)
    input.addEventListener('keyup', function(e){
      // if user typed a number or '.' move to next cell optionally (not forced)
      const key = e.key;
      if(/^[0-9.]$/.test(key)){
        // don't auto-advance aggressively — comment out if undesired
        // const td = input.parentElement; const tr = td.parentElement; const rowIdx = tr.sectionRowIndex + 1; const cellIdx = td.cellIndex;
        // const next = getInputAt(rowIdx, cellIdx + 1); if(next) next.focus();
      }
    });
  });
}

/* Save attendance to Firestore (owner-only) */
$('saveAll').onclick = async ()=>{
  if(!isOwnerSignedIn()){ alert('Owner sign-in required to save.'); return; }
  const month = $('ownerMonth').value; if(!month){ alert('Select month'); return; }
  const toSave = {};
  document.querySelectorAll('#ownerTable tbody tr').forEach(tr=>{
    const id = tr.dataset.id;
    const key = `${id}_${month}`;
    const shifts = {};
    tr.querySelectorAll('.attCell').forEach(ci => { const d = ci.dataset.day; shifts[d] = Number(ci.value) || 0; });
    const rate = Number(getRateForLabour(id)) || null;
    toSave[key] = { shifts, rate };
  });
  try {
    await saveAttendanceForMonth(toSave);
    alert('Attendance saved to Firestore.');
  } catch(err){
    alert('Save failed: ' + err.message);
  }
};

/* Owner search */
function ownerFilter(){
  const q = $('ownerSearch').value.trim().toLowerCase();
  document.querySelectorAll('#ownerTable tbody tr').forEach(tr=>{
    const text = (tr.querySelector('.sticky-name')?.textContent || '').toLowerCase();
    tr.style.display = (!q || text.includes(q)) ? '' : 'none';
  });
}

/* Advances UI */
async function populateAdvSelect(){
  // populate datalist for searchable advLab input
  const data = document.getElementById('advLabList');
  data.innerHTML = '';
  const labs = await fetchAllLabours();
  // add options as "ID - Name" and also ID alone for quick selection
  labs.forEach(l => {
    const opt = document.createElement('option');
    opt.value = `${l.id} - ${l.name}`;
    data.appendChild(opt);
    const opt2 = document.createElement('option');
    opt2.value = l.id;
    data.appendChild(opt2);
  });
}

$('showAdv').onclick = renderAdvances;

async function renderAdvances(){
  const month = $('advMonth').value || $('ownerMonth').value;
  const labs = await fetchAllLabours();
  const tbody = document.querySelector('#advTable tbody'); tbody.innerHTML = '';
  // The user wanted "name save by time order not alphabetical" — we fetchAllLabours which sorts by createdAt desc when available
  for(let i=0;i<labs.length;i++){
    const l = labs[i];
    const items = await fetchAdvancesForLab(l.id);
    // preserve insertion order (array order) then filter by month
    const filtered = items.filter(a => a.date && a.date.startsWith(month));
    const tot = filtered.reduce((s,x)=> s + (Number(x.amount)||0), 0);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${l.id}</td><td class="left">${l.name}</td><td>₹${tot}</td><td><button onclick="prefillAdv('${l.id}')">Add</button> <button onclick="viewAdvances('${l.id}','${month}')">View</button></td>`;
    tbody.appendChild(tr);
  }
  await populateAdvSelect();
}

/* Save advance (owner-only) */
$('saveAdv').onclick = async ()=>{
  if(!isOwnerSignedIn()){ alert('Owner sign-in required to save advance.'); return; }
  let labVal = $('advLab').value.trim();
  if(!labVal){ alert('Enter labour (ID or "ID - Name")'); return; }
  // normalize lab id if user typed "L001 - Name" or "L001"
  const possibleId = labVal.split(' - ')[0].trim();
  const labId = possibleId;
  const date = $('advDate').value; const amt = Number($('advAmt').value) || 0; const note = $('advNote').value;
  if(!labId || !date || amt <= 0){ alert('Select labour, date and amount'); return; }
  try{
    await appendAdvanceForLab(labId, {date, amount: amt, note});
    $('advDate').value=''; $('advAmt').value=''; $('advNote').value=''; $('advLab').value='';
    await renderAdvances(); await renderSalarySheet();
    alert('Advance saved to Firestore');
    // after save, scroll to top as requested
    window.scrollTo({top:0, behavior:'smooth'});
  } catch(err){
    alert('Save advance failed: ' + err.message);
  }
};
$('clearAdv').onclick = ()=>{ $('advDate').value=''; $('advAmt').value=''; $('advNote').value=''; $('advLab').value=''; };
function prefillAdv(id){
  // prefill using "ID - Name" for convenience
  fetchLabourById(id).then(lab=>{
    if(lab) $('advLab').value = `${id} - ${lab.name}`;
    else $('advLab').value = id;
    $('advDate').value = (new Date()).toISOString().slice(0,10);
    // scroll to advance section and focus amount
    document.getElementById('addAdvTitle').scrollIntoView({behavior:'smooth', block:'center'});
    setTimeout(()=> $('advAmt').focus(), 600);
  });
}

/* View advances (open tab) */
async function viewAdvances(id, month){
  const items = await fetchAdvancesForLab(id);
  let list = items;
  if(month) list = list.filter(a=> a.date && a.date.startsWith(month));
  // preserve insertion order (assumed pushed order) and sort chronologically (old -> new) if date present
  list.sort((a,b)=> (a.date||'') < (b.date||'') ? -1 : ((a.date||'') > (b.date||'') ? 1 : 0));
  let html = `<html><head><meta charset="utf-8"><title>Advances ${id}</title><style>table{border-collapse:collapse;width:100%}th,td{border:1px solid #333;padding:6px}th{background:#eee}</style></head><body><h2>Advances — ${id}</h2>`;
  if(list.length === 0) html += '<p>No advances</p>'; else {
    html += '<table><thead><tr><th>Date</th><th>Amount</th><th>Note</th></tr></thead><tbody>';
    list.forEach(a=> html += `<tr><td>${a.date}</td><td style="text-align:right">₹${a.amount}</td><td>${a.note||''}</td></tr>`);
    html += '</tbody></table>';
    const tot = list.reduce((s,x)=> s + (Number(x.amount)||0), 0);
    html += `<p><strong>Total: ₹${tot}</strong></p>`;
  }
  html += '</body></html>';
  const w = window.open('', '_blank'); w.document.write(html); w.document.close();
}

/* Salary sheet UI (reads from Firestore) */
$('showSalary').onclick = renderSalarySheet;

async function renderSalarySheet(){
  const month = $('salaryMonth').value || $('ownerMonth').value; if(!month){ alert('Select month'); return; }
  const labs = await fetchAllLabours();
  const tbody = document.querySelector('#salaryTable tbody'); tbody.innerHTML = '';
  for(let i=0;i<labs.length;i++){
    const l = labs[i];
    const att = await fetchAttendance(l.id, month);
    const totalShift = Object.values(att.shifts || {}).reduce((s,v)=> s + (Number(v)||0), 0);
    const advItems = await fetchAdvancesForLab(l.id);
    const advTotal = advItems.filter(a=> a.date && a.date.startsWith(month)).reduce((s,x)=> s + (Number(x.amount)||0), 0);
    const saved = await fetchSalary(l.id, month) || {};
    const amtPerShift = Number(saved.amtPerShift !== undefined ? saved.amtPerShift : (att.rate || l.rate)) || Number(l.rate||0);
    const totalAmt = Number((amtPerShift * totalShift).toFixed(2));
    const monthlyAdvance = advTotal;
    const mess = Number(saved.mess||0), uf = Number(saved.uf||0), pf = Number(saved.pf||0), debit = Number(saved.debit||0), jvc = Number(saved.jvc||0), other = Number(saved.other||0);
    const deductions = Number((monthlyAdvance + mess + uf + pf + debit + jvc + other).toFixed(2));
    const calcPaid = Number((totalAmt - deductions).toFixed(2));
    const paid = saved.paid !== undefined ? Number(saved.paid) : calcPaid;
    // NOTE: use saved.paymentMode OR labour.paymentMode OR default Cash
    const paymentMode = saved.paymentMode || l.paymentMode || 'Cash';
    const remarks = saved.remarks || '';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="sticky-id">${i+1}</td><td class="sticky-name">${l.id} - ${l.name}</td>
      <td><input class="sal-amt" data-id="${l.id}" value="${amtPerShift}" style="width:90px" step="any"></td>
      <td><input class="sal-totalShift readonly" data-id="${l.id}" value="${totalShift}" readonly style="width:90px"></td>
      <td><input class="sal-totalAmt readonly" data-id="${l.id}" value="${totalAmt}" readonly style="width:110px"></td>
      <td><input class="sal-monthlyAdvance readonly" data-id="${l.id}" value="${monthlyAdvance}" readonly style="width:110px"></td>
      <td><input class="sal-mess" data-id="${l.id}" value="${mess}" style="width:90px"></td>
      <td><input class="sal-uf" data-id="${l.id}" value="${uf}" style="width:90px"></td>
      <td><input class="sal-pf" data-id="${l.id}" value="${pf}" style="width:90px"></td>
      <td><input class="sal-debit" data-id="${l.id}" value="${debit}" style="width:90px"></td>
      <td><input class="sal-jvc" data-id="${l.id}" value="${jvc}" style="width:90px"></td>
      <td><input class="sal-other" data-id="${l.id}" value="${other}" style="width:90px"></td>
      <td>
        <select class="sal-paymode" data-id="${l.id}" style="width:100px">
          <option value="Cash"${paymentMode === 'Cash' ? ' selected' : ''}>Cash</option>
          <option value="A/c"${paymentMode === 'A/c' ? ' selected' : ''}>A/c</option>
        </select>
      </td>
      <td><input class="sal-paid" data-id="${l.id}" value="${paid}" style="width:110px"></td>
      <td><input class="sal-remarks" data-id="${l.id}" value="${remarks}" placeholder="Remarks / Signature" style="width:160px"></td>`;
    tbody.appendChild(tr);
  }
  document.querySelectorAll('#salaryTable input, #salaryTable select').forEach(inp => inp.addEventListener('input', salaryInputsChanged));
}

/* salary inputs recalc */
function salaryInputsChanged(e){
  const id = e.target.dataset.id; if(!id) return;
  const row = Array.from(document.querySelectorAll('#salaryTable tbody tr')).find(tr => tr.querySelector('.sal-amt')?.dataset.id === id);
  if(!row) return;
  const amtPerShift = Number(row.querySelector('.sal-amt').value) || 0;
  const totalShift = Number(row.querySelector('.sal-totalShift').value) || 0;
  const totalAmt = Number((amtPerShift * totalShift).toFixed(2));
  row.querySelector('.sal-totalAmt').value = totalAmt;
  const monthlyAdvance = Number(row.querySelector('.sal-monthlyAdvance').value) || 0;
  const mess = Number(row.querySelector('.sal-mess').value) || 0;
  const uf = Number(row.querySelector('.sal-uf').value) || 0;
  const pf = Number(row.querySelector('.sal-pf').value) || 0;
  const debit = Number(row.querySelector('.sal-debit').value) || 0;
  const jvc = Number(row.querySelector('.sal-jvc').value) || 0;
  const other = Number(row.querySelector('.sal-other').value) || 0;
  const deductions = Number((monthlyAdvance + mess + uf + pf + debit + jvc + other).toFixed(2));
  const calcPaid = Number((totalAmt - deductions).toFixed(2));
  const paidInput = row.querySelector('.sal-paid');
  paidInput.value = calcPaid;
}

/* Save salary sheet to Firestore (owner-only) */
$('saveSalary').onclick = async ()=>{
  if(!isOwnerSignedIn()){ alert('Owner sign-in required to save salary.'); return; }
  const month = $('salaryMonth').value || $('ownerMonth').value; if(!month){ alert('Select month'); return; }
  try{
    const rows = document.querySelectorAll('#salaryTable tbody tr');
    for(const r of rows){
      const id = r.querySelector('.sal-amt').dataset.id;
      const payload = {
        amtPerShift: Number(r.querySelector('.sal-amt').value) || 0,
        totalShift: Number(r.querySelector('.sal-totalShift').value) || 0,
        totalAmt: Number(r.querySelector('.sal-totalAmt').value) || 0,
        monthlyAdvance: Number(r.querySelector('.sal-monthlyAdvance').value) || 0,
        mess: Number(r.querySelector('.sal-mess').value) || 0,
        uf: Number(r.querySelector('.sal-uf').value) || 0,
        pf: Number(r.querySelector('.sal-pf').value) || 0,
        debit: Number(r.querySelector('.sal-debit').value) || 0,
        jvc: Number(r.querySelector('.sal-jvc').value) || 0,
        other: Number(r.querySelector('.sal-other').value) || 0,
        paymentMode: r.querySelector('.sal-paymode').value || '',
        paid: Number(r.querySelector('.sal-paid').value) || 0,
        remarks: r.querySelector('.sal-remarks').value || ''
      };
      await saveSalaryRecord(id, month, payload);
    }
    alert('Salary sheet saved to Firestore for ' + month);
  } catch(err){
    alert('Save salary failed: ' + err.message);
  }
};

/* Export helpers (collect attendance/salary from Firestore per month) */
async function collectShiftRows(month){
  const labs = await fetchAllLabours();
  const rows = [];
  for(const [i,l] of labs.entries()){
    const key = `${l.id}_${month}`;
    const doc = await db.collection('attendance').doc(key).get();
    const rec = doc.exists ? doc.data() : {shifts:{}};
    const days = getDays(month);
    const dayVals = [], total=0;
    let tot=0;
    for(const d of days){ const v = Number(rec.shifts && (rec.shifts[d] !== undefined) ? rec.shifts[d] : 0) || 0; dayVals.push(v); tot += v; }
    rows.push({sno:i+1, id:l.id, name:l.name, days: dayVals, total: tot});
  }
  return {rows, days: getDays(month)};
}
async function exportShiftCSV(){ const month = $('ownerMonth').value; if(!month){ alert('Select month'); return; } const data=await collectShiftRows(month); const header=['S.No','User ID','Name', ...data.days.map(String), 'Total']; const csv=[header.join(',')].concat(data.rows.map(r=> [r.sno, r.id, `"${r.name.replace(/"/g,'""')}"`, ...r.days, r.total].join(','))).join('\n'); downloadBlob(csv, `shifts_${month}.csv`, 'text/csv'); }
async function exportShiftXLS(){ const month=$('ownerMonth').value; if(!month){alert('Select month');return;} const data=await collectShiftRows(month); let html='<table border="1"><tr>'+['S.No','User ID','Name',...data.days.map(String),'Total'].map(h=>`<th>${h}</th>`).join('')+'</tr>'; data.rows.forEach(r=>{ html+='<tr>'; html+=`<td>${r.sno}</td><td>${r.id}</td><td>${r.name}</td>` + r.days.map(d=>`<td>${d}</td>`).join('') + `<td>${r.total}</td></tr>`;}); html+='</table>'; downloadBlob('\uFEFF'+html, `shifts_${month}.xls`, 'application/vnd.ms-excel'); }
async function exportShiftPDF(){ const month=$('ownerMonth').value; if(!month){alert('Select month');return;} const data=await collectShiftRows(month); let html=`<html><head><meta charset="utf-8"><title>Shift sheet ${month}</title><style>table{border-collapse:collapse;width:100%}th,td{border:1px solid #333;padding:6px;text-align:center}th{background:#eee}td.left{text-align:left;padding-left:6px}</style></head><body><h2>Shift sheet — ${month}</h2><table><thead><tr>`+ ['S.No','User ID','Name',...data.days.map(String),'Total'].map(h=>`<th>${h}</th>`).join('')+`</tr></thead><tbody>`; data.rows.forEach(r=>{ html+=`<tr><td>${r.sno}</td><td>${r.id}</td><td class="left">${r.name}</td>`+ r.days.map(d=>`<td>${d}</td>`).join('') + `<td>${r.total}</td></tr>`; }); html+='</tbody></table><p style="color:#666">Generated by Shift Portal (Firestore)</p></body></html>'; const w=window.open('', '_blank'); w.document.write(html); w.document.close(); }

async function collectSalaryRows(month){
  const labs = await fetchAllLabours(); const rows = [];
  for(const [i,l] of labs.entries()){
    const att = await fetchAttendance(l.id, month);
    const totalShift = Object.values(att.shifts||{}).reduce((s,v)=> s + (Number(v)||0), 0);
    const saved = await fetchSalary(l.id, month) || {};
    const amtPerShift = Number(saved.amtPerShift !== undefined ? saved.amtPerShift : (att.rate || l.rate)) || Number(l.rate||0);
    const totalAmt = Number((amtPerShift * totalShift).toFixed(2));
    const advItems = await fetchAdvancesForLab(l.id);
    const advTotal = advItems.filter(a=> a.date && a.date.startsWith(month)).reduce((s,x)=> s + (Number(x.amount)||0), 0);
    const mess = Number(saved.mess||0), uf = Number(saved.uf||0), pf = Number(saved.pf||0), debit = Number(saved.debit||0), jvc = Number(saved.jvc||0), other = Number(saved.other||0);
    const paid = Number(saved.paid !== undefined ? saved.paid : (totalAmt - (advTotal + mess + uf + pf + debit + jvc + other))).toFixed(2);
    const paymentMode = (saved.paymentMode || l.paymentMode || '').toString();
    const remarks = saved.remarks || '';
    rows.push({sno:i+1, id:l.id, name:l.name, amtPerShift, totalShift, totalAmt, monthlyAdvance: advTotal, mess, uf, pf, debit, jvc, other, paymentMode, paid, remarks});
  }
  return rows;
}
async function exportSalaryCSV(){ const month=$('salaryMonth').value || $('ownerMonth').value; if(!month){alert('Select month');return;} const rows=await collectSalaryRows(month); const header=['S.No','User ID','Name','Amt/Shift','Total Shift','Total Amt','Monthly Advance','Mess','U/F','P/F','Debit','JVC','Other','Payment Mode','Paid Salary','Remarks']; const csv=[header.join(',')].concat(rows.map(r=> [r.sno, r.id, `"${r.name.replace(/"/g,'""')}"`, r.amtPerShift, r.totalShift, r.totalAmt, r.monthlyAdvance, r.mess, r.uf, r.pf, r.debit, r.jvc, r.other, `"${r.paymentMode}"`, r.paid, `"${(r.remarks||'').replace(/"/g,'""')}"`].join(','))).join('\n'); downloadBlob(csv, `salary_${month}.csv`, 'text/csv'); }
async function exportSalaryXLS(){ const month=$('salaryMonth').value || $('ownerMonth').value; if(!month){alert('Select month');return;} const rows=await collectSalaryRows(month); let html='<table border="1"><tr>'+['S.No','User ID','Name','Amt/Shift','Total Shift','Total Amt','Monthly Advance','Mess','U/F','P/F','Debit','JVC','Other','Payment Mode','Paid Salary','Remarks'].map(h=>`<th>${h}</th>`).join('')+'</tr>'; rows.forEach(r=> html+=`<tr><td>${r.sno}</td><td>${r.id}</td><td>${r.name}</td><td>${r.amtPerShift}</td><td>${r.totalShift}</td><td>${r.totalAmt}</td><td>${r.monthlyAdvance}</td><td>${r.mess}</td><td>${r.uf}</td><td>${r.pf}</td><td>${r.debit}</td><td>${r.jvc}</td><td>${r.other}</td><td>${r.paymentMode}</td><td>${r.paid}</td><td>${r.remarks}</td></tr>`); html += '</table>'; downloadBlob('\uFEFF'+html, `salary_${month}.xls`, 'application/vnd.ms-excel'); }

/* UPDATED: exportSalaryPDF now separates A/c and Cash tables (A/c first) and S.No restarts for each group */
async function exportSalaryPDF(){
   const month=$('salaryMonth').value || $('ownerMonth').value;
   if(!month){alert('Select month');return;}
   const rows=await collectSalaryRows(month);
   const acRows = rows.filter(r => (r.paymentMode||'').toString().toLowerCase() === 'a/c');
   const cashRows = rows.filter(r => (r.paymentMode||'').toString().toLowerCase() !== 'a/c');

   function buildTableHtml(rowsArray, title){
     if(rowsArray.length === 0) return `<h4>${title}: (none)</h4>`;
     let html = `<h4 style="margin-bottom:6px">${title}</h4><table><thead><tr>`;
     ['S.No','User ID','Name','Amt/Shift','Total Shift','Total Amt','Monthly Advance','Mess','U/F','P/F','Debit','JVC','Other','Payment Mode','Paid Salary','Remarks'].forEach(h=> html += `<th>${h}</th>`);
     html += `</tr></thead><tbody>`;
     rowsArray.forEach((r, idx) => {
       html += `<tr><td>${idx+1}</td><td>${r.id}</td><td style="text-align:left;padding-left:6px">${r.name}</td><td>${r.amtPerShift}</td><td>${r.totalShift}</td><td>${r.totalAmt}</td><td>${r.monthlyAdvance}</td><td>${r.mess}</td><td>${r.uf}</td><td>${r.pf}</td><td>${r.debit}</td><td>${r.jvc}</td><td>${r.other}</td><td>${r.paymentMode}</td><td>${r.paid}</td><td>${r.remarks||''}</td></tr>`;
     });
     html += `</tbody></table>`;
     return html;
   }

   let html = `<html><head><meta charset="utf-8"><title>Salary ${month}</title>
    <style>
      body{font-family:Arial,Helvetica,sans-serif;color:#222}
      h2{margin-bottom:0}
      table{border-collapse:collapse;width:100%;margin-bottom:18px}
      th,td{border:1px solid #333;padding:6px;text-align:center;font-size:12px}
      th{background:#eee}
      td{text-align:center}
      td.left{text-align:left;padding-left:6px}
      @media print{
        table{page-break-inside:auto}
        tr{page-break-inside:avoid;page-break-after:auto}
      }
    </style>
   </head><body>
   <h2>Salary sheet — ${month}</h2>
   <p style="color:#666">Generated by Salary Portal (Firestore)</p>
   `;
   html += buildTableHtml(acRows, 'Payment Mode: A/c');
   html += `<div style="height:16px"></div>`;
   html += buildTableHtml(cashRows, 'Payment Mode: Cash');
   html += `</body></html>`;
   const w=window.open('', '_blank'); w.document.write(html); w.document.close();
}

/* ===== ADVANCES export functions (new) ===== */
async function collectAdvForMonth(month){
  const labs = await fetchAllLabours();
  const rows = [];
  for(const [i,l] of labs.entries()){
    const items = await fetchAdvancesForLab(l.id);
    // preserve insertion order (as pushed)
    const filtered = items.filter(a => a.date && a.date.startsWith(month));
    for(const f of filtered){
      rows.push({sno: rows.length+1, id: l.id, name: l.name, date: f.date, amount: Number(f.amount)||0, note: f.note||''});
    }
  }
  return rows;
}
async function exportAdvCSV(){ const month = $('advMonth').value || $('ownerMonth').value; if(!month){ alert('Select month'); return; } const rows = await collectAdvForMonth(month); const header = ['S.No','User ID','Name','Date','Amount','Note']; const csv = [header.join(',')].concat(rows.map(r => [r.sno, r.id, `"${r.name.replace(/"/g,'""')}"`, r.date, r.amount, `"${(r.note||'').replace(/"/g,'""')}"`].join(','))).join('\n'); downloadBlob(csv, `advances_${month}.csv`, 'text/csv'); }
async function exportAdvXLS(){ const month = $('advMonth').value || $('ownerMonth').value; if(!month){ alert('Select month'); return; } const rows = await collectAdvForMonth(month); let html = '<table border="1"><tr>' + ['S.No','User ID','Name','Date','Amount','Note'].map(h=>`<th>${h}</th>`).join('') + '</tr>'; rows.forEach(r => { html += `<tr><td>${r.sno}</td><td>${r.id}</td><td>${r.name}</td><td>${r.date}</td><td>${r.amount}</td><td>${r.note}</td></tr>`; }); html += '</table>'; downloadBlob('\uFEFF'+html, `advances_${month}.xls`, 'application/vnd.ms-excel'); }
async function exportAdvPDF(){ const month = $('advMonth').value || $('ownerMonth').value; if(!month){ alert('Select month'); return; } const rows = await collectAdvForMonth(month); let html = `<html><head><meta charset="utf-8"><title>Advances ${month}</title><style>table{border-collapse:collapse;width:100%}th,td{border:1px solid #333;padding:6px;text-align:center}th{background:#eee}td.left{text-align:left;padding-left:6px}</style></head><body><h2>Advances — ${month}</h2>`; if(rows.length === 0){ html += '<p>No advances for selected month.</p>'; } else { html += '<table><thead><tr><th>S.No</th><th>User ID</th><th>Name</th><th>Date</th><th>Amount</th><th>Note</th></tr></thead><tbody>'; rows.forEach(r => { html += `<tr><td>${r.sno}</td><td>${r.id}</td><td class="left">${r.name}</td><td>${r.date}</td><td style="text-align:right">${r.amount}</td><td class="left">${r.note}</td></tr>`; }); html += '</tbody></table>'; const total = rows.reduce((s,x)=> s + (Number(x.amount)||0), 0); html += `<p><strong>Total Advances: ₹${total}</strong></p>`; } html += '</body></html>'; const w=window.open('', '_blank'); w.document.write(html); w.document.close(); }

/* ===== labour export event wiring (buttons) ===== */
$('exportShiftCSV').onclick = exportShiftCSV; $('exportShiftXLS').onclick = exportShiftXLS; $('exportShiftPDF').onclick = exportShiftPDF;
$('exportSalaryCSV').onclick = exportSalaryCSV; $('exportSalaryXLS').onclick = exportSalaryXLS; $('exportSalaryPDF').onclick = exportSalaryPDF;
/* advances */ $('exportAdvCSV').onclick = exportAdvCSV; $('exportAdvXLS').onclick = exportAdvXLS; $('exportAdvPDF').onclick = exportAdvPDF;

function downloadBlob(content, filename, mime){ const blob = new Blob([content], {type:mime}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

/* ===== Labour management (owner-only) ===== */
async function renderLabourList(){
  const labs = await fetchAllLabours();
  let html='<table><thead><tr><th>S.No</th><th>User ID</th><th>Name</th><th>Rate/shift</th><th>Payment Mode</th><th>Actions</th></tr></thead><tbody>';
  labs.forEach((l,i)=> html += `<tr><td>${i+1}</td><td>${l.id}</td><td class="left">${l.name}</td><td>₹${l.rate}</td><td>${l.paymentMode || 'Cash'}</td><td><button onclick="openEditLabour('${l.id}')">Edit</button> <button onclick="deleteLabour('${l.id}')">Delete</button></td></tr>`);
  html += '</tbody></table>';
  $('labourList').innerHTML = html;
}
$('addLabour').onclick = ()=> openLabourModal();

function openLabourModal(editId){
  $('labourModal').classList.remove('hidden');
  // scroll to modal
  $('labourModal').scrollIntoView({behavior:'smooth', block:'center'});
  if(editId){
    fetchLabourById(editId).then(lab=>{
      $('labourModalTitle').textContent = 'Edit Labour';
      $('modalUserId').value = lab.id; $('modalName').value = lab.name; $('modalPwd').value = lab.password; $('modalRate').value = lab.rate;
      // populate payment mode select
      $('modalPayMode').value = lab.paymentMode || 'Cash';
      $('labourModal').dataset.edit = editId;
    }).catch(()=>{ alert('Failed to fetch labour'); });
  } else {
    $('labourModalTitle').textContent = 'Add Labour';
    $('modalUserId').value=''; $('modalName').value=''; $('modalPwd').value='1234'; $('modalRate').value='500';
    $('modalPayMode').value = 'Cash';
    delete $('labourModal').dataset.edit;
  }
}
function openEditLabour(id){ openLabourModal(id); }
$('cancelLabourBtn').onclick = ()=> $('labourModal').classList.add('hidden');

$('saveLabourBtn').onclick = async ()=>{
  if(!isOwnerSignedIn()){ alert('Owner sign-in required'); return; }
  const id=$('modalUserId').value.trim(), name=$('modalName').value.trim(), pwd=$('modalPwd').value.trim(), rate=Number($('modalRate').value)||0;
  const paymentMode = $('modalPayMode').value || 'Cash';
  if(!id||!name){ alert('Enter ID and name'); return; }
  try{
    // Save and ensure createdAt handled in saveLabourToFirestore
    await saveLabourToFirestore({id, name, password: pwd, rate, paymentMode});
    $('labourModal').classList.add('hidden'); await renderLabourList(); await generateOwnerTable(); await populateAdvSelect(); await renderSalarySheet();
    alert('Saved');
    // scroll back to top after save
    window.scrollTo({top:0, behavior:'smooth'});
  } catch(err){ alert('Save failed: ' + err.message); }
};

async function deleteLabour(id){
  if(!isOwnerSignedIn()){ alert('Owner sign-in required to delete labour.'); return; }
  if(!confirm('Delete labour and all data?')) return;
  try{
    await deleteLabourFromFirestore(id);
    await renderLabourList(); await generateOwnerTable(); await renderSalarySheet(); await renderAdvances();
    alert('Deleted ' + id);
  } catch(err){ alert('Delete failed: ' + err.message); }
}

/* ===== Labour UI (view only) ===== */
function renderLabourInfo(){ if(!currentLabour) return; $('labourInfo').innerHTML = `<p><strong>${currentLabour.name}</strong> (ID: ${currentLabour.id})</p>`; }
async function renderLabourView(){
  if(!currentLabour) return; const month = $('labourMonth').value; if(!month) return;
  const rec = await fetchAttendance(currentLabour.id, month);
  const days = getDays(month);
  let html = '<h3>Attendance</h3><table><thead><tr><th>Date</th><th>Shifts</th></tr></thead><tbody>';
  let total = 0;
  days.forEach(d=>{ const v = Number(rec.shifts && rec.shifts[d] !== undefined ? rec.shifts[d] : 0) || 0; html += `<tr><td class="left">${d}</td><td>${v}</td></tr>`; total += v; });
  html += `</tbody></table><p class="small">Total shifts: ${total}</p>`;
  $('labourAttendance').innerHTML = html;

  const advItemsAll = await fetchAdvancesForLab(currentLabour.id);
  const advList = advItemsAll.filter(a=> a.date && a.date.startsWith(month)).sort((a,b)=> a.date < b.date ? -1 : (a.date > b.date ? 1 : 0));
  let advHtml = '<h3>Advances</h3>';
  if(!advList.length) advHtml += '<p class="small">No advances for month</p>'; else { advHtml += '<table><thead><tr><th>Date</th><th>Amount</th><th>Note</th></tr></thead><tbody>'; advList.slice().reverse().forEach(a=> advHtml += `<tr><td>${a.date}</td><td style="text-align:right">₹${a.amount}</td><td class="left">${a.note||''}</td></tr>`); advHtml += '</tbody></table>'; advHtml += `<p class="small"><strong>Total: ₹${advList.reduce((s,x)=> s + (Number(x.amount)||0),0)}</strong></p>`; }
  $('labourAdvance').innerHTML = advHtml;

  const saved = await fetchSalary(currentLabour.id, month) || {};
  const amtPerShift = Number(saved.amtPerShift !== undefined ? saved.amtPerShift : (rec.rate||currentLabour.rate)) || currentLabour.rate;
  const totalShift = Object.values(rec.shifts||{}).reduce((s,v)=> s + (Number(v)||0), 0);
  const totalAmt = Number((amtPerShift * totalShift).toFixed(2));
  const advTotal = advList.reduce((s,x)=> s + (Number(x.amount)||0), 0);
  const mess = Number(saved.mess||0), uf = Number(saved.uf||0), pf = Number(saved.pf||0), debit = Number(saved.debit||0), jvc = Number(saved.jvc||0), other = Number(saved.other||0);
  const deductions = Number((advTotal + mess + uf + pf + debit + jvc + other).toFixed(2));
  const paidCalculated = Number((totalAmt - deductions).toFixed(2));
  let salaryHtml = `<h3>Salary — ${month}</h3>`;
  salaryHtml += `<table><tbody>`;
  salaryHtml += `<tr><td class="left">Amt/Shift</td><td>₹${amtPerShift}</td></tr>`;
  salaryHtml += `<tr><td class="left">Total Shift</td><td>${totalShift}</td></tr>`;
  salaryHtml += `<tr><td class="left">Total Amount</td><td>₹${totalAmt}</td></tr>`;
  salaryHtml += `<tr><td class="left">Monthly Advance (sum of advances)</td><td>₹${advTotal}</td></tr>`;
  salaryHtml += `<tr><td class="left">Mess</td><td>₹${mess}</td></tr>`;
  salaryHtml += `<tr><td class="left">U/F</td><td>₹${uf}</td></tr>`;
  salaryHtml += `<tr><td class="left">P/F</td><td>₹${pf}</td></tr>`;
  salaryHtml += `<tr><td class="left">Debit</td><td>₹${debit}</td></tr>`;
  salaryHtml += `<tr><td class="left">JVC</td><td>₹${jvc}</td></tr>`;
  salaryHtml += `<tr><td class="left">Other</td><td>₹${other}</td></tr>`;
  salaryHtml += `<tr><td class="left"><strong>Paid (calculated)</strong></td><td><strong>₹${paidCalculated}</strong></td></tr>`;
  salaryHtml += `<tr><td class="left">Paid (owner saved)</td><td>${saved.paid !== undefined ? '₹'+saved.paid : '—'}</td></tr>`;
  salaryHtml += `</tbody></table>`;
  $('labourSalary').innerHTML = salaryHtml;
}

/* ===== Ownership/sign-in guard ===== */
function isOwnerSignedIn(){
  const user = auth.currentUser;
  return user && user.uid === OWNER_UID;
}
auth.onAuthStateChanged(user => {
  if(user) $('ownerAuthMsg').textContent = 'Signed in as UID: ' + user.uid;
  else $('ownerAuthMsg').textContent = '';
});

/* ===== Utility functions ===== */
function daysInMonth(y,m){ return new Date(y,m,0).getDate(); }
function getDays(monthStr){ const [y,m] = monthStr.split('-').map(Number); const n = daysInMonth(y,m); const arr=[]; for(let d=1; d<=n; d++) arr.push(d); return arr; }
function getRateForLabour(id){ return 0; }

/* ===== On load initial rendering: fetch labours to show in lists where possible ===== */
window.addEventListener('load', async ()=>{
  try{
    await renderLabourList();
    await populateAdvSelect();
  }catch(e){ console.warn('Init load: ', e.message); }
});
</script>
</body>
</html>
